<!DOCTYPE html>
<html lang="zh-CN" data-theme="light">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <meta name="generator" content="VuePress 2.0.0-beta.38" />
    <meta name="theme" content="VuePress Theme Hope" />
    <meta property="og:url" content="https://vuepress-theme-hope-v2-demo.mrhope.site/middleware/mq/Kafka.html"><meta property="og:site_name" content="主题演示"><meta property="og:title" content="初学Kafka"><meta property="og:type" content="article"><meta property="og:updated_time" content="2022-04-11T06:40:49.000Z"><meta property="og:locale" content="zh-CN"><meta property="article:tag" content="Kafka"><meta property="article:published_time" content="2022-04-11T00:00:00.000Z"><meta property="article:modified_time" content="2022-04-11T06:40:49.000Z"><link rel="stylesheet" href="//at.alicdn.com/t/font_3316994_13t317rc8al.css"><title>初学Kafka | 主题演示</title><meta name="description" content="vuepress-theme-hope 的演示">
    <style>
      :root {
        --bg-color: #fff;
      }

      html[data-theme="dark"] {
        --bg-color: #1d2025;
      }

      html,
      body {
        background-color: var(--bg-color);
      }
    </style>
    <script>
      const userMode = localStorage.getItem("vuepress-theme-hope-scheme");
      const systemDarkMode =
        window.matchMedia &&
        window.matchMedia("(prefers-color-scheme: dark)").matches;

      if (userMode === "dark" || (userMode !== "light" && systemDarkMode)) {
        document.querySelector("html").setAttribute("data-theme", "dark");
      }
    </script>
    <link rel="stylesheet" href="/assets/style.7c8a6ce0.css">
    <link rel="modulepreload" href="/assets/app.62233a0d.js"><link rel="modulepreload" href="/assets/Kafka.html.cacc4684.js"><link rel="modulepreload" href="/assets/Kafka.html.a7381dc4.js">
  </head>
  <body>
    <div id="app"><!--[--><!--[--><!--[--><span tabindex="-1"></span><a href="#main-content" class="skip-link sr-only">Skip to content</a><!--]--><div class="theme-container has-toc sidebar-open"><!--[--><header class="navbar"><button class="toggle-sidebar-button" title="Toggle Sidebar"><span class="icon"></span></button><a href="/" class="home-link"><img class="logo" src="/logo.svg" alt="主题演示"><!----><span class="site-name hide-in-pad">主题演示</span><!--[--><!----><!--]--></a><nav class="nav-links" style=""><div class="nav-item hide-in-mobile"><a href="/" class="nav-link" arialabel="主页"><i class="icon iconfont icon-home"></i>主页<!----></a></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="后端"><span class="title"><i class="icon iconfont icon-rearend"></i>后端</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/rearend/java/" class="nav-link" arialabel="Java"><i class="icon iconfont icon-java"></i>Java<!----></a></li><li class="dropdown-item"><a href="/rearend/springBoot/" class="nav-link" arialabel="Spring Boot"><i class="icon iconfont icon-springBoot"></i>Spring Boot<!----></a></li><li class="dropdown-item"><a href="/rearend/microServices/" class="nav-link" arialabel="微服务"><i class="icon iconfont icon-microServices"></i>微服务<!----></a></li><li class="dropdown-item"><a href="/rearend/dataStructure/" class="nav-link" arialabel="数据结构"><i class="icon iconfont icon-dataStructure"></i>数据结构<!----></a></li><li class="dropdown-item"><a href="/rearend/algorithm/" class="nav-link" arialabel="算法"><i class="icon iconfont icon-algorithm"></i>算法<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="中间件"><span class="title"><i class="icon iconfont icon-middleware"></i>中间件</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/middleware/database/" class="nav-link" arialabel="数据库"><i class="icon iconfont icon-database"></i>数据库<!----></a></li><li class="dropdown-item"><a href="/middleware/noSQL/" class="nav-link" arialabel="NoSQL"><i class="icon iconfont icon-noSQL"></i>NoSQL<!----></a></li><li class="dropdown-item"><a href="/middleware/mq/" class="nav-link active" arialabel="MQ"><i class="icon iconfont icon-MQ"></i>MQ<!----></a></li><li class="dropdown-item"><a href="/middleware/zookeeper/" class="nav-link" arialabel="Zookeeper"><i class="icon iconfont icon-zookeeper"></i>Zookeeper<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="服务器"><span class="title"><i class="icon iconfont icon-server"></i>服务器</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/server/linux/" class="nav-link" arialabel="Linux"><i class="icon iconfont icon-linux"></i>Linux<!----></a></li><li class="dropdown-item"><a href="/server/docker/" class="nav-link" arialabel="Docker"><i class="icon iconfont icon-docker"></i>Docker<!----></a></li><li class="dropdown-item"><a href="/server/kubernetes/" class="nav-link" arialabel="Kubernetes"><i class="icon iconfont icon-kubernetes"></i>Kubernetes<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="前端"><span class="title"><i class="icon iconfont icon-wangye"></i>前端</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>框架</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/framework/js/" class="nav-link" arialabel="Java Script"><i class="icon iconfont icon-react"></i>Java Script<!----></a></li><li class="dropdown-subitem"><a href="/web/framework/vue/" class="nav-link" arialabel="Vue"><i class="icon iconfont icon-vue"></i>Vue<!----></a></li><li class="dropdown-subitem"><a href="/web/framework/react/" class="nav-link" arialabel="React"><i class="icon iconfont icon-react"></i>React<!----></a></li><li class="dropdown-subitem"><a href="/web/framework/docsify/" class="nav-link" arialabel="Docsify"><i class="icon iconfont icon-docs"></i>Docsify<!----></a></li><li class="dropdown-subitem"><a href="/web/framework/vuepress/" class="nav-link" arialabel="VuePress"><i class="icon iconfont icon-folder-vuepress"></i>VuePress<!----></a></li></ul></li><li class="dropdown-item"><h4 class="dropdown-subtitle"><span>页面</span></h4><ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/web/ui/element/" class="nav-link" arialabel="Element UI"><i class="icon iconfont icon-element-ui"></i>Element UI<!----></a></li><li class="dropdown-subitem"><a href="/web/ui/iview/" class="nav-link" arialabel="View UI"><i class="icon iconfont icon-iview"></i>View UI<!----></a></li></ul></li></ul></button></div></div><div class="nav-item hide-in-mobile"><div class="dropdown-wrapper"><button class="dropdown-title" type="button" arialabel="索引"><span class="title"><i class="icon iconfont icon-index"></i>索引</span><span class="arrow"></span><ul class="nav-dropdown"><li class="dropdown-item"><a href="/article/" class="nav-link" arialabel="文章"><i class="icon iconfont icon-articles"></i>文章<!----></a></li><li class="dropdown-item"><a href="/category/java/" class="nav-link" arialabel="分类"><i class="icon iconfont icon-category"></i>分类<!----></a></li><li class="dropdown-item"><a href="/tag/" class="nav-link" arialabel="标签"><i class="icon iconfont icon-tag"></i>标签<!----></a></li><li class="dropdown-item"><a href="/timeline/" class="nav-link" arialabel="时间轴"><i class="icon iconfont icon-timeLine"></i>时间轴<!----></a></li></ul></button></div></div><div class="nav-item hide-in-mobile"><a href="https://vuepress-theme-hope.github.io/v2/zh/" rel="noopener noreferrer" target="_blank" arialabel="主题文档" class="nav-link"><i class="icon iconfont icon-note"></i>主题文档<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div></nav><div class="nav-actions-wrapper"><!--[--><!----><!--]--><div class="nav-item"><!----></div><div class="nav-item"><a class="repo-link" href="https://github.com/vuepress-theme-hope/vuepress-theme-hope" target="_blank" rel="noopener noreferrer"><svg xmlns="http://www.w3.org/2000/svg" class="icon github-icon" viewbox="0 0 1024 1024" arialabelledby="github" style="width:1.25rem;height:1.25rem;vertical-align:middle;"><title id="github" lang="en">github icon</title><g fill="currentColor"><path d="M511.957 21.333C241.024 21.333 21.333 240.981 21.333 512c0 216.832 140.544 400.725 335.574 465.664 24.49 4.395 32.256-10.07 32.256-23.083 0-11.69.256-44.245 0-85.205-136.448 29.61-164.736-64.64-164.736-64.64-22.315-56.704-54.4-71.765-54.4-71.765-44.587-30.464 3.285-29.824 3.285-29.824 49.195 3.413 75.179 50.517 75.179 50.517 43.776 75.008 114.816 53.333 142.762 40.79 4.523-31.66 17.152-53.377 31.19-65.537-108.971-12.458-223.488-54.485-223.488-242.602 0-53.547 19.114-97.323 50.517-131.67-5.035-12.33-21.93-62.293 4.779-129.834 0 0 41.258-13.184 134.912 50.346a469.803 469.803 0 0 1 122.88-16.554c41.642.213 83.626 5.632 122.88 16.554 93.653-63.488 134.784-50.346 134.784-50.346 26.752 67.541 9.898 117.504 4.864 129.834 31.402 34.347 50.474 78.123 50.474 131.67 0 188.586-114.73 230.016-224.042 242.09 17.578 15.232 33.578 44.672 33.578 90.454v135.85c0 13.142 7.936 27.606 32.854 22.87C862.25 912.597 1002.667 728.747 1002.667 512c0-271.019-219.648-490.667-490.71-490.667z"></path></g></svg></a></div><div class="nav-item hide-in-mobile"><button class="outlook-button" tabindex="-1" ariahidden="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon outlook-icon" viewbox="0 0 1024 1024" arialabelledby="outlook"><title id="outlook" lang="en">outlook icon</title><g fill="currentColor"><path d="M224 800c0 9.6 3.2 44.8 6.4 54.4 6.4 48-48 76.8-48 76.8s80 41.6 147.2 0 134.4-134.4 38.4-195.2c-22.4-12.8-41.6-19.2-57.6-19.2C259.2 716.8 227.2 761.6 224 800zM560 675.2l-32 51.2c-51.2 51.2-83.2 32-83.2 32 25.6 67.2 0 112-12.8 128 25.6 6.4 51.2 9.6 80 9.6 54.4 0 102.4-9.6 150.4-32l0 0c3.2 0 3.2-3.2 3.2-3.2 22.4-16 12.8-35.2 6.4-44.8-9.6-12.8-12.8-25.6-12.8-41.6 0-54.4 60.8-99.2 137.6-99.2 6.4 0 12.8 0 22.4 0 12.8 0 38.4 9.6 48-25.6 0-3.2 0-3.2 3.2-6.4 0-3.2 3.2-6.4 3.2-6.4 6.4-16 6.4-16 6.4-19.2 9.6-35.2 16-73.6 16-115.2 0-105.6-41.6-198.4-108.8-268.8C704 396.8 560 675.2 560 675.2zM224 419.2c0-28.8 22.4-51.2 51.2-51.2 28.8 0 51.2 22.4 51.2 51.2 0 28.8-22.4 51.2-51.2 51.2C246.4 470.4 224 448 224 419.2zM320 284.8c0-22.4 19.2-41.6 41.6-41.6 22.4 0 41.6 19.2 41.6 41.6 0 22.4-19.2 41.6-41.6 41.6C339.2 326.4 320 307.2 320 284.8zM457.6 208c0-12.8 12.8-25.6 25.6-25.6 12.8 0 25.6 12.8 25.6 25.6 0 12.8-12.8 25.6-25.6 25.6C470.4 233.6 457.6 220.8 457.6 208zM128 505.6C128 592 153.6 672 201.6 736c28.8-60.8 112-60.8 124.8-60.8-16-51.2 16-99.2 16-99.2l316.8-422.4c-48-19.2-99.2-32-150.4-32C297.6 118.4 128 291.2 128 505.6zM764.8 86.4c-22.4 19.2-390.4 518.4-390.4 518.4-22.4 28.8-12.8 76.8 22.4 99.2l9.6 6.4c35.2 22.4 80 12.8 99.2-25.6 0 0 6.4-12.8 9.6-19.2 54.4-105.6 275.2-524.8 288-553.6 6.4-19.2-3.2-32-19.2-32C777.6 76.8 771.2 80 764.8 86.4z"></path></g></svg><div class="outlook-dropdown"><!----></div></button></div><!----><button class="toggle-navbar-button" aria-label="Toggle Navbar" aria-expanded="false" aria-controls="nav-screen"><span class="button-container"><span class="button-top"></span><span class="button-middle"></span><span class="button-bottom"></span></span></button><!--[--><!----><!--]--></div></header><!----><!--]--><!----><div class="toggle-sidebar-wrapper"><span class="arrow left"></span></div><aside class="sidebar"><!--[--><!----><!--]--><ul class="sidebar-links"><li><!--[--><a href="/middleware/mq/" class="nav-link sidebar-link sidebar-page" arialabel="MQ"><i class="icon iconfont icon-MQ"></i>MQ<!----></a><ul class="sidebar-sub-headers"></ul><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">RabbitMQ</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable"><!----><span class="title">RocketMQ</span><span class="arrow right"></span></button><!--[--><!--[--><!----><!--]--><!----><!--]--></section><!--]--></li><li><!--[--><section class="sidebar-group"><button class="sidebar-heading clickable active"><!----><span class="title">kafka</span><span class="arrow down"></span></button><!--[--><!--[--><ul class="sidebar-links"><li><!--[--><a aria-current="page" href="/middleware/mq/Kafka.html" class="router-link-active router-link-exact-active nav-link active sidebar-link sidebar-page active" arialabel="初学Kafka"><!---->初学Kafka<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-1-基本概念" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.1 基本概念"><!---->1.1 基本概念<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-消息队列" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.2 消息队列"><!---->1.2 消息队列<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-1-消息队列应用场景" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.2.1 消息队列应用场景"><!---->1.2.1 消息队列应用场景<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-2-消息队列两种模式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.2.2 消息队列两种模式"><!---->1.2.2 消息队列两种模式<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-3-基本架构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="1.3 基本架构"><!---->1.3 基本架构<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-安装部署" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1 安装部署"><!---->2.1 安装部署<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-1-集群规划" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1.1 集群规划"><!---->2.1.1 集群规划<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-2-集群部署" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.1.2 集群部署"><!---->2.1.2 集群部署<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-kafka命令行操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2 Kafka命令行操作"><!---->2.2 Kafka命令行操作<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-1-主题命令行操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2.1 主题命令行操作"><!---->2.2.1 主题命令行操作<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-2-生产者命令行操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.2.2 生产者命令行操作"><!---->2.2.2 生产者命令行操作<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-3-3-消费者命令行操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="2.3.3 消费者命令行操作"><!---->2.3.3 消费者命令行操作<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-生产者发送消息流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1 生产者发送消息流程"><!---->3.1 生产者发送消息流程<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-1-发送原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1.1 发送原理"><!---->3.1.1 发送原理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-2-生产者重要参数列表" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.1.2 生产者重要参数列表"><!---->3.1.2 生产者重要参数列表<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-异步发送api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2 异步发送API"><!---->3.2 异步发送API<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-1-普通异步发送" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2.1 普通异步发送"><!---->3.2.1 普通异步发送<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-2-带回调函数异步发送" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.2.2 带回调函数异步发送"><!---->3.2.2 带回调函数异步发送<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-3-同步发送api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.3 同步发送API"><!---->3.3 同步发送API<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-生产者分区" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.4 生产者分区"><!---->3.4 生产者分区<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-1-分区的好处" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.4.1 分区的好处"><!---->3.4.1 分区的好处<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-2-分区策略" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.4.2 分区策略"><!---->3.4.2 分区策略<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-3-自定义分区器" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.4.3 自定义分区器"><!---->3.4.3 自定义分区器<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-5-生产者提高吞吐量" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.5 生产者提高吞吐量"><!---->3.5 生产者提高吞吐量<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-6-数据可靠性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.6 数据可靠性"><!---->3.6 数据可靠性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-数据去重" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.7 数据去重"><!---->3.7 数据去重<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-1-数据传递语义" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.7.1 数据传递语义"><!---->3.7.1 数据传递语义<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-2-幂等性" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.7.2 幂等性"><!---->3.7.2 幂等性<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-3-事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.7.3 事务"><!---->3.7.3 事务<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-8-数据有序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.8 数据有序"><!---->3.8 数据有序<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-9-数据乱序" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="3.9 数据乱序"><!---->3.9 数据乱序<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-broker工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1 Broker工作流程"><!---->4.1 Broker工作流程<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-1-zookeeper存储的kafka信息" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1.1 Zookeeper存储的Kafka信息"><!---->4.1.1 Zookeeper存储的Kafka信息<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-2-broker总体工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1.2 Broker总体工作流程"><!---->4.1.2 Broker总体工作流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-3-broker重要参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.1.3 Broker重要参数"><!---->4.1.3 Broker重要参数<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-节点服役和退役" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2 节点服役和退役"><!---->4.2 节点服役和退役<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-1-服役新节点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2.1 服役新节点"><!---->4.2.1 服役新节点<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-2-退役旧节点" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.2.2 退役旧节点"><!---->4.2.2 退役旧节点<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-kafka副本" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3 Kafka副本"><!---->4.3 Kafka副本<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-1-副本基本信息" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.1 副本基本信息"><!---->4.3.1 副本基本信息<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-2-leader选举流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.2 Leader选举流程"><!---->4.3.2 Leader选举流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-3-leader和follower故障处理细节" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.3 Leader和Follower故障处理细节"><!---->4.3.3 Leader和Follower故障处理细节<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-4-分区副本分配" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.4 分区副本分配"><!---->4.3.4 分区副本分配<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-5-手动调整分区副本存储" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.5 手动调整分区副本存储"><!---->4.3.5 手动调整分区副本存储<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-6-leader-partition负载均衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.6 Leader Partition负载均衡"><!---->4.3.6 Leader Partition负载均衡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-7-增加副本因子" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.3.7 增加副本因子"><!---->4.3.7 增加副本因子<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-文件存储" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.4 文件存储"><!---->4.4 文件存储<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-1-文件存储机制" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.4.1 文件存储机制"><!---->4.4.1 文件存储机制<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-2-文件清理策略" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.4.2 文件清理策略"><!---->4.4.2 文件清理策略<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-5-高效读写数据" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="4.5 高效读写数据"><!---->4.5 高效读写数据<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-1-kafka消费方式" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.1 Kafka消费方式"><!---->5.1 Kafka消费方式<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-kafka消费者工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2 Kafka消费者工作流程"><!---->5.2 Kafka消费者工作流程<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-1-消费者总体工作流程" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2.1 消费者总体工作流程"><!---->5.2.1 消费者总体工作流程<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-2-消费者组原理" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2.2 消费者组原理"><!---->5.2.2 消费者组原理<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-3-消费者重要参数" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.2.3 消费者重要参数"><!---->5.2.3 消费者重要参数<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-消费者-api" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3 消费者 API"><!---->5.3 消费者 API<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-1-独立消费者案例-订阅主题" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3.1 独立消费者案例（订阅主题）"><!---->5.3.1 独立消费者案例（订阅主题）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-2-独立消费者案例-订阅分区" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3.2 独立消费者案例（订阅分区）"><!---->5.3.2 独立消费者案例（订阅分区）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-3-消费者组案例" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.3.3 消费者组案例"><!---->5.3.3 消费者组案例<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-生产经验——分区的分配以及再平衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4 生产经验——分区的分配以及再平衡"><!---->5.4 生产经验——分区的分配以及再平衡<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-1-range以及再平衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4.1 Range以及再平衡"><!---->5.4.1 Range以及再平衡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-2-roundrobin-以及再平衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4.2 RoundRobin 以及再平衡"><!---->5.4.2 RoundRobin 以及再平衡<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-3-sticky-以及再平衡" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.4.3 Sticky 以及再平衡"><!---->5.4.3 Sticky 以及再平衡<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-offset-位移" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5 offset 位移"><!---->5.5 offset 位移<!----></a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-1-offset-的默认维护位置" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.1 offset 的默认维护位置"><!---->5.5.1 offset 的默认维护位置<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-2-自动提交-offset" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.2 自动提交 offset"><!---->5.5.2 自动提交 offset<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-3-手动提交-offset" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.3 手动提交 offset"><!---->5.5.3 手动提交 offset<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-4-指定-offset-消费" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.4 指定 Offset 消费"><!---->5.5.4 指定 Offset 消费<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-5-指定时间消费" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.5 指定时间消费"><!---->5.5.5 指定时间消费<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-6-漏消费和重复消费" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.5.6 漏消费和重复消费"><!---->5.5.6 漏消费和重复消费<!----></a><ul class="sidebar-sub-headers"></ul></li></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-6-生产经验——消费者事务" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.6 生产经验——消费者事务"><!---->5.6 生产经验——消费者事务<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-7-生产经验——数据积压-消费者如何提高吞吐量" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="5.7 生产经验——数据积压（消费者如何提高吞吐量）"><!---->5.7 生产经验——数据积压（消费者如何提高吞吐量）<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-1-mysql-环境准备" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.1 MySQL 环境准备"><!---->6.1 MySQL 环境准备<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-2-kafka-环境准备" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.2 Kafka 环境准备"><!---->6.2 Kafka 环境准备<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-3-kafka-eagle-安装" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.3 Kafka-Eagle 安装"><!---->6.3 Kafka-Eagle 安装<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-4-kafka-eagle-页面操作" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="6.4 Kafka-Eagle 页面操作"><!---->6.4 Kafka-Eagle 页面操作<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-1-kafka-kraft-架构" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.1 Kafka-Kraft 架构"><!---->7.1 Kafka-Kraft 架构<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-2-kafka-kraft-集群部署" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.2 Kafka-Kraft 集群部署"><!---->7.2 Kafka-Kraft 集群部署<!----></a><ul class="sidebar-sub-headers"></ul></li><li class="sidebar-sub-header"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-3-kafka-kraft-集群启动停止脚本" class="router-link-active router-link-exact-active nav-link sidebar-link heading" arialabel="7.3 Kafka-Kraft 集群启动停止脚本"><!---->7.3 Kafka-Kraft 集群启动停止脚本<!----></a><ul class="sidebar-sub-headers"></ul></li></ul><!--]--></li></ul><!--]--><!----><!--]--></section><!--]--></li></ul><!--[--><!----><!--]--></aside><!--[--><main class="page" id="main-content"><!----><nav class="breadcrumb disable"></nav><div class="page-title"><h1><!---->初学Kafka</h1><div class="article-info"><span class="author-info" arialabel="作者🖊" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon author-icon" viewbox="0 0 1024 1024" arialabelledby="author"><title id="author" lang="en">author icon</title><g fill="currentColor"><path d="M649.6 633.6c86.4-48 147.2-144 147.2-249.6 0-160-128-288-288-288s-288 128-288 288c0 108.8 57.6 201.6 147.2 249.6-121.6 48-214.4 153.6-240 288-3.2 9.6 0 19.2 6.4 25.6 3.2 9.6 12.8 12.8 22.4 12.8h704c9.6 0 19.2-3.2 25.6-12.8 6.4-6.4 9.6-16 6.4-25.6-25.6-134.4-121.6-240-243.2-288z"></path></g></svg><span><a class="author-item" href="https://mrhope.site" target="_blank" rel="noopener noreferrer">Code Chen</a></span><span property="author" content="Code Chen"></span></span><!----><span class="date-info" arialabel="写作日期📅" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon calendar-icon" viewbox="0 0 1024 1024" arialabelledby="calendar"><title id="calendar" lang="en">calendar icon</title><g fill="currentColor"><path d="M716.4 110.137c0-18.753-14.72-33.473-33.472-33.473-18.753 0-33.473 14.72-33.473 33.473v33.473h66.993v-33.473zm-334.87 0c0-18.753-14.72-33.473-33.473-33.473s-33.52 14.72-33.52 33.473v33.473h66.993v-33.473zm468.81 33.52H716.4v100.465c0 18.753-14.72 33.473-33.472 33.473a33.145 33.145 0 01-33.473-33.473V143.657H381.53v100.465c0 18.753-14.72 33.473-33.473 33.473a33.145 33.145 0 01-33.473-33.473V143.657H180.6A134.314 134.314 0 0046.66 277.595v535.756A134.314 134.314 0 00180.6 947.289h669.74a134.36 134.36 0 00133.94-133.938V277.595a134.314 134.314 0 00-133.94-133.938zm33.473 267.877H147.126a33.145 33.145 0 01-33.473-33.473c0-18.752 14.72-33.473 33.473-33.473h736.687c18.752 0 33.472 14.72 33.472 33.473a33.145 33.145 0 01-33.472 33.473z"></path></g></svg><span>2022年4月11日</span><meta property="datePublished" content="2022-04-11T00:00:00.000Z"></span><span class="category-info" arialabel="分类🌈" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon category-icon" viewbox="0 0 1024 1024" arialabelledby="category"><title id="category" lang="en">category icon</title><g fill="currentColor"><path d="M148.41 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H148.41c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.311-40.31zM147.556 553.478H429.73c22.263 0 40.311 18.048 40.311 40.31v282.176c0 22.263-18.048 40.312-40.31 40.312H147.555c-22.263 0-40.311-18.049-40.311-40.312V593.79c0-22.263 18.048-40.311 40.31-40.311zM593.927 106.992h282.176c22.263 0 40.31 18.048 40.31 40.31V429.48c0 22.263-18.047 40.31-40.31 40.31H593.927c-22.263 0-40.311-18.047-40.311-40.31V147.302c0-22.263 18.048-40.31 40.31-40.31zM730.22 920.502H623.926c-40.925 0-74.22-33.388-74.22-74.425V623.992c0-41.038 33.387-74.424 74.425-74.424h222.085c41.038 0 74.424 33.226 74.424 74.067v114.233c0 10.244-8.304 18.548-18.547 18.548s-18.548-8.304-18.548-18.548V623.635c0-20.388-16.746-36.974-37.33-36.974H624.13c-20.585 0-37.331 16.747-37.331 37.33v222.086c0 20.585 16.654 37.331 37.126 37.331H730.22c10.243 0 18.547 8.304 18.547 18.547 0 10.244-8.304 18.547-18.547 18.547z"></path></g></svg><ul class="categories-wrapper"><li class="category category5 clickable" role="navigation">中间件</li><li class="category category7 clickable" role="navigation">MQ</li><meta property="articleSection" content="中间件,MQ"></ul></span><span arialabel="标签🏷" data-balloon-pos="down" isoriginal="false" pageview="false"><svg xmlns="http://www.w3.org/2000/svg" class="icon tag-icon" viewbox="0 0 1024 1024" arialabelledby="tag"><title id="tag" lang="en">tag icon</title><g fill="currentColor"><path d="M939.902 458.563L910.17 144.567c-1.507-16.272-14.465-29.13-30.737-30.737L565.438 84.098h-.402c-3.215 0-5.726 1.005-7.634 2.913l-470.39 470.39a10.004 10.004 0 000 14.164l365.423 365.424c1.909 1.908 4.42 2.913 7.132 2.913s5.223-1.005 7.132-2.913l470.39-470.39c2.01-2.11 3.014-5.023 2.813-8.036zm-240.067-72.121c-35.458 0-64.286-28.828-64.286-64.286s28.828-64.285 64.286-64.285 64.286 28.828 64.286 64.285-28.829 64.286-64.286 64.286z"></path></g></svg><ul class="tags-wrapper"><li class="tag tag2 clickable" role="navigation">Kafka</li></ul><meta property="keywords" content="Kafka"></span><span class="reading-time-info" arialabel="阅读时间⌛" data-balloon-pos="down" isoriginal="false" pageview="false" color="true"><svg xmlns="http://www.w3.org/2000/svg" class="icon timer-icon" viewbox="0 0 1024 1024" arialabelledby="timer"><title id="timer" lang="en">timer icon</title><g fill="currentColor"><path d="M799.387 122.15c4.402-2.978 7.38-7.897 7.38-13.463v-1.165c0-8.933-7.38-16.312-16.312-16.312H256.33c-8.933 0-16.311 7.38-16.311 16.312v1.165c0 5.825 2.977 10.874 7.637 13.592 4.143 194.44 97.22 354.963 220.201 392.763-122.204 37.542-214.893 196.511-220.2 389.397-4.661 5.049-7.638 11.651-7.638 19.03v5.825h566.49v-5.825c0-7.379-2.849-13.981-7.509-18.9-5.049-193.016-97.867-351.985-220.2-389.527 123.24-37.67 216.446-198.453 220.588-392.892zM531.16 450.445v352.632c117.674 1.553 211.787 40.778 211.787 88.676H304.097c0-48.286 95.149-87.382 213.728-88.676V450.445c-93.077-3.107-167.901-81.297-167.901-177.093 0-8.803 6.99-15.793 15.793-15.793 8.803 0 15.794 6.99 15.794 15.793 0 80.261 63.69 145.635 142.01 145.635s142.011-65.374 142.011-145.635c0-8.803 6.99-15.793 15.794-15.793s15.793 6.99 15.793 15.793c0 95.019-73.789 172.82-165.96 177.093z"></path></g></svg><span>大约 37 分钟</span><meta property="timeRequired" content="PT37M"></span></div><hr></div><div class="toc-place-holder"><aside id="toc-list"><div class="toc-header">此页内容</div><div class="toc-wrapper"><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-1-基本概念" class="router-link-active router-link-exact-active toc-link level2">1.1 基本概念</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-消息队列" class="router-link-active router-link-exact-active toc-link level2">1.2 消息队列</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-1-消息队列应用场景" class="router-link-active router-link-exact-active toc-link level3">1.2.1 消息队列应用场景</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-2-2-消息队列两种模式" class="router-link-active router-link-exact-active toc-link level3">1.2.2 消息队列两种模式</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_1-3-基本架构" class="router-link-active router-link-exact-active toc-link level2">1.3 基本架构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-安装部署" class="router-link-active router-link-exact-active toc-link level2">2.1 安装部署</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-1-集群规划" class="router-link-active router-link-exact-active toc-link level3">2.1.1 集群规划</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-1-2-集群部署" class="router-link-active router-link-exact-active toc-link level3">2.1.2 集群部署</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-kafka命令行操作" class="router-link-active router-link-exact-active toc-link level2">2.2 Kafka命令行操作</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-1-主题命令行操作" class="router-link-active router-link-exact-active toc-link level3">2.2.1 主题命令行操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-2-2-生产者命令行操作" class="router-link-active router-link-exact-active toc-link level3">2.2.2 生产者命令行操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_2-3-3-消费者命令行操作" class="router-link-active router-link-exact-active toc-link level3">2.3.3 消费者命令行操作</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-生产者发送消息流程" class="router-link-active router-link-exact-active toc-link level2">3.1 生产者发送消息流程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-1-发送原理" class="router-link-active router-link-exact-active toc-link level3">3.1.1 发送原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-1-2-生产者重要参数列表" class="router-link-active router-link-exact-active toc-link level3">3.1.2 生产者重要参数列表</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-异步发送api" class="router-link-active router-link-exact-active toc-link level2">3.2 异步发送API</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-1-普通异步发送" class="router-link-active router-link-exact-active toc-link level3">3.2.1 普通异步发送</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-2-2-带回调函数异步发送" class="router-link-active router-link-exact-active toc-link level3">3.2.2 带回调函数异步发送</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-3-同步发送api" class="router-link-active router-link-exact-active toc-link level2">3.3 同步发送API</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-生产者分区" class="router-link-active router-link-exact-active toc-link level2">3.4 生产者分区</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-1-分区的好处" class="router-link-active router-link-exact-active toc-link level3">3.4.1 分区的好处</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-2-分区策略" class="router-link-active router-link-exact-active toc-link level3">3.4.2 分区策略</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-4-3-自定义分区器" class="router-link-active router-link-exact-active toc-link level3">3.4.3 自定义分区器</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-5-生产者提高吞吐量" class="router-link-active router-link-exact-active toc-link level2">3.5 生产者提高吞吐量</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-6-数据可靠性" class="router-link-active router-link-exact-active toc-link level2">3.6 数据可靠性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-数据去重" class="router-link-active router-link-exact-active toc-link level2">3.7 数据去重</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-1-数据传递语义" class="router-link-active router-link-exact-active toc-link level3">3.7.1 数据传递语义</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-2-幂等性" class="router-link-active router-link-exact-active toc-link level3">3.7.2 幂等性</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-7-3-事务" class="router-link-active router-link-exact-active toc-link level3">3.7.3 事务</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-8-数据有序" class="router-link-active router-link-exact-active toc-link level2">3.8 数据有序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_3-9-数据乱序" class="router-link-active router-link-exact-active toc-link level2">3.9 数据乱序</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-broker工作流程" class="router-link-active router-link-exact-active toc-link level2">4.1 Broker工作流程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-1-zookeeper存储的kafka信息" class="router-link-active router-link-exact-active toc-link level3">4.1.1 Zookeeper存储的Kafka信息</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-2-broker总体工作流程" class="router-link-active router-link-exact-active toc-link level3">4.1.2 Broker总体工作流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-1-3-broker重要参数" class="router-link-active router-link-exact-active toc-link level3">4.1.3 Broker重要参数</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-节点服役和退役" class="router-link-active router-link-exact-active toc-link level2">4.2 节点服役和退役</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-1-服役新节点" class="router-link-active router-link-exact-active toc-link level3">4.2.1 服役新节点</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-2-2-退役旧节点" class="router-link-active router-link-exact-active toc-link level3">4.2.2 退役旧节点</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-kafka副本" class="router-link-active router-link-exact-active toc-link level2">4.3 Kafka副本</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-1-副本基本信息" class="router-link-active router-link-exact-active toc-link level3">4.3.1 副本基本信息</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-2-leader选举流程" class="router-link-active router-link-exact-active toc-link level3">4.3.2 Leader选举流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-3-leader和follower故障处理细节" class="router-link-active router-link-exact-active toc-link level3">4.3.3 Leader和Follower故障处理细节</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-4-分区副本分配" class="router-link-active router-link-exact-active toc-link level3">4.3.4 分区副本分配</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-5-手动调整分区副本存储" class="router-link-active router-link-exact-active toc-link level3">4.3.5 手动调整分区副本存储</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-6-leader-partition负载均衡" class="router-link-active router-link-exact-active toc-link level3">4.3.6 Leader Partition负载均衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-3-7-增加副本因子" class="router-link-active router-link-exact-active toc-link level3">4.3.7 增加副本因子</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-文件存储" class="router-link-active router-link-exact-active toc-link level2">4.4 文件存储</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-1-文件存储机制" class="router-link-active router-link-exact-active toc-link level3">4.4.1 文件存储机制</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-4-2-文件清理策略" class="router-link-active router-link-exact-active toc-link level3">4.4.2 文件清理策略</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_4-5-高效读写数据" class="router-link-active router-link-exact-active toc-link level2">4.5 高效读写数据</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-1-kafka消费方式" class="router-link-active router-link-exact-active toc-link level2">5.1 Kafka消费方式</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-kafka消费者工作流程" class="router-link-active router-link-exact-active toc-link level2">5.2 Kafka消费者工作流程</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-1-消费者总体工作流程" class="router-link-active router-link-exact-active toc-link level3">5.2.1 消费者总体工作流程</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-2-消费者组原理" class="router-link-active router-link-exact-active toc-link level3">5.2.2 消费者组原理</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-2-3-消费者重要参数" class="router-link-active router-link-exact-active toc-link level3">5.2.3 消费者重要参数</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-消费者-api" class="router-link-active router-link-exact-active toc-link level2">5.3 消费者 API</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-1-独立消费者案例-订阅主题" class="router-link-active router-link-exact-active toc-link level3">5.3.1 独立消费者案例（订阅主题）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-2-独立消费者案例-订阅分区" class="router-link-active router-link-exact-active toc-link level3">5.3.2 独立消费者案例（订阅分区）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-3-3-消费者组案例" class="router-link-active router-link-exact-active toc-link level3">5.3.3 消费者组案例</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-生产经验——分区的分配以及再平衡" class="router-link-active router-link-exact-active toc-link level2">5.4 生产经验——分区的分配以及再平衡</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-1-range以及再平衡" class="router-link-active router-link-exact-active toc-link level3">5.4.1 Range以及再平衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-2-roundrobin-以及再平衡" class="router-link-active router-link-exact-active toc-link level3">5.4.2 RoundRobin 以及再平衡</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-4-3-sticky-以及再平衡" class="router-link-active router-link-exact-active toc-link level3">5.4.3 Sticky 以及再平衡</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-offset-位移" class="router-link-active router-link-exact-active toc-link level2">5.5 offset 位移</a></li><ul class="toc-list"><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-1-offset-的默认维护位置" class="router-link-active router-link-exact-active toc-link level3">5.5.1 offset 的默认维护位置</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-2-自动提交-offset" class="router-link-active router-link-exact-active toc-link level3">5.5.2 自动提交 offset</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-3-手动提交-offset" class="router-link-active router-link-exact-active toc-link level3">5.5.3 手动提交 offset</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-4-指定-offset-消费" class="router-link-active router-link-exact-active toc-link level3">5.5.4 指定 Offset 消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-5-指定时间消费" class="router-link-active router-link-exact-active toc-link level3">5.5.5 指定时间消费</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-5-6-漏消费和重复消费" class="router-link-active router-link-exact-active toc-link level3">5.5.6 漏消费和重复消费</a></li><!----><!--]--></ul><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-6-生产经验——消费者事务" class="router-link-active router-link-exact-active toc-link level2">5.6 生产经验——消费者事务</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_5-7-生产经验——数据积压-消费者如何提高吞吐量" class="router-link-active router-link-exact-active toc-link level2">5.7 生产经验——数据积压（消费者如何提高吞吐量）</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-1-mysql-环境准备" class="router-link-active router-link-exact-active toc-link level2">6.1 MySQL 环境准备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-2-kafka-环境准备" class="router-link-active router-link-exact-active toc-link level2">6.2 Kafka 环境准备</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-3-kafka-eagle-安装" class="router-link-active router-link-exact-active toc-link level2">6.3 Kafka-Eagle 安装</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_6-4-kafka-eagle-页面操作" class="router-link-active router-link-exact-active toc-link level2">6.4 Kafka-Eagle 页面操作</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-1-kafka-kraft-架构" class="router-link-active router-link-exact-active toc-link level2">7.1 Kafka-Kraft 架构</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-2-kafka-kraft-集群部署" class="router-link-active router-link-exact-active toc-link level2">7.2 Kafka-Kraft 集群部署</a></li><!----><!--]--><!--[--><li class="toc-item"><a aria-current="page" href="/middleware/mq/Kafka.html#_7-3-kafka-kraft-集群启动停止脚本" class="router-link-active router-link-exact-active toc-link level2">7.3 Kafka-Kraft 集群启动停止脚本</a></li><!----><!--]--></ul></div></aside></div><!----><div class="theme-hope-content"><!--[--><h1 id="第一章-kafka概述" tabindex="-1"><a class="header-anchor" href="#第一章-kafka概述" aria-hidden="true">#</a> 第一章 Kafka概述</h1><h2 id="_1-1-基本概念" tabindex="-1"><a class="header-anchor" href="#_1-1-基本概念" aria-hidden="true">#</a> 1.1 基本概念</h2><p><strong>Kafka传统定义</strong>：Kafka是一个<strong>分布式</strong>的基于<strong>发布/订阅</strong>模式的<strong>消息队列</strong>（MessageQueue），主要应用于大数据实时处理领域。</p><p><strong>Kafka最新定义</strong>： Kafka是 一个开源的<strong>分布式事件流平台</strong> （Event Streaming Platform），被数千家公司用于<strong>高性能数据管道、流分析、数据集成和关键任务应用</strong>。</p><p><strong>发布/订阅</strong>：消息的发布者不会将消息直接发送给特定的订阅者，而是<strong>将发布的消息分为不同的类别</strong>，订阅者<strong>只接收感兴趣的消息</strong>。</p><p><a href="https://kafka.apache.org/" target="_blank" rel="noopener noreferrer">Kafka官网地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p><h2 id="_1-2-消息队列" tabindex="-1"><a class="header-anchor" href="#_1-2-消息队列" aria-hidden="true">#</a> 1.2 消息队列</h2><p><strong>常见的消息队列产品</strong>：<strong>Kafka</strong>、<strong>ActiveMQ</strong> 、<strong>RabbitMQ</strong> 、<strong>RocketMQ</strong></p><h3 id="_1-2-1-消息队列应用场景" tabindex="-1"><a class="header-anchor" href="#_1-2-1-消息队列应用场景" aria-hidden="true">#</a> 1.2.1 消息队列应用场景</h3><p>主要应用场景包括：<strong>缓存/削峰</strong>、<strong>解耦</strong>、<strong>异步</strong></p><ul><li><p>消息队列应用场景——缓存/削峰</p><p><strong>缓存/削峰</strong>：有助于控制和优化数据流经过系统的速度，解决生产消息和消费消息的处理速度不一致的情况。</p></li><li><p>消息队列的应用场景——解耦</p><p><strong>解耦</strong>：允许你独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束。</p></li><li><p>消息队列的应用场景——异步通信</p><p><strong>异步通信</strong>：允许用户把一个消息放入队列，但并不立即处理它，然后在需要的时候再去处理它们。</p></li></ul><h3 id="_1-2-2-消息队列两种模式" tabindex="-1"><a class="header-anchor" href="#_1-2-2-消息队列两种模式" aria-hidden="true">#</a> 1.2.2 消息队列两种模式</h3><ol><li><p><strong>点对点模式</strong></p><ul><li><p>消费者主动拉取数据，消息收到后清除消息</p></li></ul></li><li><p><strong>发布/订阅模式</strong></p><ul><li><p>可以有多个topic主题（浏览、点赞、收藏、评论等）</p></li><li><p>消费者消费数据之后，不删除数据</p></li><li><p>每个消费者相互独立，都可以消费到数据</p></li></ul></li></ol><h2 id="_1-3-基本架构" tabindex="-1"><a class="header-anchor" href="#_1-3-基本架构" aria-hidden="true">#</a> 1.3 基本架构</h2><ol><li>为方便扩展，并提高吞吐量，一个topic分为多个partition</li><li>配合分区的设计，提出消费者组的概念，组内每个消费者并行消费</li><li>为提高可用性，为每个partition增加若干副本，类似NameNode HA</li><li>ZK中记录谁是leader，Kafka 2.8.0以后也可以配置不采用ZK</li></ol><p>（1）<strong>Producer</strong>：<strong>消息生产者</strong>，就是向 Kafka broker发消息的客户端。</p><p>（2）<strong>Consumer</strong>：<strong>消息消费者</strong>，向 Kafka broker 取消息的客户端。</p><p>（3）<strong>Consumer Group（CG）</strong>：消费者组，由多个 consumer 组成。消费者组内每个消费者负责消费不同分区的数据，<strong>一个分区只能由一个组内消费者消费</strong>；消费者组之间互不影响。所有的消费者都属于某个消费者组，即消费者组是逻辑上的一个订阅者。</p><p>（4）<strong>Broker</strong>：一台 Kafka 服务器就是一个 broker，一个集群由多个 broker 组成，一个broker 可以容纳多个 topic。</p><p>（5）<strong>Topic</strong>：可以理解为一个队列，生产者和消费者面向的都是一个 topic。</p><p>（6）<strong>Partition</strong>：为了实现扩展性，一个非常大的 topic 可以分布到多个 broker（即服务器）上，一个 topic 可以分为多个 partition，每个 partition 是一个有序的队列。</p><p>（7）<strong>Replica</strong>：副本。一个 topic 的每个分区都有若干个副本，一个 Leader 和若干个Follower。</p><p>（8）<strong>Leader</strong>：每个分区多个副本的“主”，生产者发送数据的对象，以及消费者消费数据的对象都是 Leader。</p><p>（9）<strong>Follower</strong>：每个分区多个副本中的“从”，实时从 Leader 中同步数据，保持和Leader 数据的同步。Leader 发生故障时，某个 Follower 会成为新的 Leader。</p><h1 id="第二章-kafka快速入门" tabindex="-1"><a class="header-anchor" href="#第二章-kafka快速入门" aria-hidden="true">#</a> 第二章 Kafka快速入门</h1><h2 id="_2-1-安装部署" tabindex="-1"><a class="header-anchor" href="#_2-1-安装部署" aria-hidden="true">#</a> 2.1 安装部署</h2><h3 id="_2-1-1-集群规划" tabindex="-1"><a class="header-anchor" href="#_2-1-1-集群规划" aria-hidden="true">#</a> 2.1.1 集群规划</h3><table><thead><tr><th>172.18.85.248(kafka01)</th><th>172.18.85.249(kafka02)</th><th>172.18.85.250(kafka03)</th></tr></thead><tbody><tr><td>zookeeper</td><td>zookeeper</td><td>zookeeper</td></tr><tr><td>kafka</td><td>kafka</td><td>kafka</td></tr></tbody></table><h3 id="_2-1-2-集群部署" tabindex="-1"><a class="header-anchor" href="#_2-1-2-集群部署" aria-hidden="true">#</a> 2.1.2 集群部署</h3><ol><li><p><a href="https://kafka.apache.org/downloads" target="_blank" rel="noopener noreferrer">官方下载地址<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></p></li><li><p>解压压缩包：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">tar</span> -zxvf kafka_2.12-3.0.0.tgz
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>修改解压后的文件夹名称：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">mv</span> kafka_2.12-3.0.0/ kafka
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>kafka目录结构：</p><div class="language-text ext-text line-numbers-mode"><pre class="language-text"><code>├── bin 脚本命令
├── config 配置文件
├── libs 第三方包
├── LICENSE
├── licenses
├── NOTICE
└── site-docs
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div></li><li><p>查看配置文件server.properties</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment">#broker 的全局唯一编号，不能重复，只能是数字。</span>
broker.id<span class="token operator">=</span><span class="token number">0</span>
<span class="token comment">#开启远程调用</span>
<span class="token assign-left variable">listeners</span><span class="token operator">=</span>PLAINTEXT://:9092
advertised.listeners<span class="token operator">=</span>PLAINTEXT://47.107.70.222:9092
<span class="token comment">#处理网络请求的线程数量</span>
num.network.threads<span class="token operator">=</span><span class="token number">3</span>
<span class="token comment">#用来处理磁盘 IO 的线程数量</span>
num.io.threads<span class="token operator">=</span><span class="token number">8</span>
<span class="token comment">#发送套接字的缓冲区大小</span>
socket.send.buffer.bytes<span class="token operator">=</span><span class="token number">102400</span>
<span class="token comment">#接收套接字的缓冲区大小</span>
socket.receive.buffer.bytes<span class="token operator">=</span><span class="token number">102400</span>
<span class="token comment">#请求套接字的缓冲区大小</span>
socket.request.max.bytes<span class="token operator">=</span><span class="token number">104857600</span>
<span class="token comment">#kafka 运行日志(数据)存放的路径，路径不需要提前创建，kafka 自动帮你创建，可以</span>
配置多个磁盘路径，路径与路径之间可以用<span class="token string">&quot;，&quot;</span>分隔
log.dirs<span class="token operator">=</span>/root/kafka/data
<span class="token comment">#topic 在当前 broker 上的分区个数</span>
num.partitions<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#用来恢复和清理 data 下数据的线程数量</span>
num.recovery.threads.per.data.dir<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment"># 每个 topic 创建时的副本数，默认时 1 个副本</span>
offsets.topic.replication.factor<span class="token operator">=</span><span class="token number">1</span>
<span class="token comment">#segment 文件保留的最长时间，超时将被删除</span>
log.retention.hours<span class="token operator">=</span><span class="token number">168</span>
<span class="token comment">#每个 segment 文件的大小，默认最大 1G</span>
log.segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
<span class="token comment"># 检查过期数据的时间，默认 5 分钟检查一次是否数据过期</span>
log.retention.check.interval.ms<span class="token operator">=</span><span class="token number">300000</span>
<span class="token comment">#配置连接 Zookeeper 集群地址（在 zk 根目录下创建/kafka，方便管理）</span>
zookeeper.connect<span class="token operator">=</span><span class="token number">172.18</span>.85.248:2181,172.18.85.249:2181,172.18.85.250:2181/kafka
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li><li><p>分发kafka安装包，在另外两台机器部署</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>./xsync kafka
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>xsync脚本如下：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token shebang important">#!/bin/bash</span>

<span class="token comment">#1. 判断参数个数</span>
<span class="token keyword">if</span> <span class="token punctuation">[</span> <span class="token variable">$#</span> -lt <span class="token number">1</span> <span class="token punctuation">]</span>
<span class="token keyword">then</span>
    <span class="token builtin class-name">echo</span> Not Enough Arguement<span class="token operator">!</span>
    <span class="token builtin class-name">exit</span><span class="token punctuation">;</span>
<span class="token keyword">fi</span>

<span class="token comment">#2. 遍历集群所有机器</span>
<span class="token keyword">for</span> <span class="token for-or-select variable">host</span> <span class="token keyword">in</span> kafka01 kafka02 kafka03
<span class="token keyword">do</span>
    <span class="token builtin class-name">echo</span> <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>  <span class="token variable">$host</span>  <span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span><span class="token operator">==</span>
    <span class="token comment">#3. 遍历所有目录，挨个发送</span>

    <span class="token keyword">for</span> <span class="token for-or-select variable">file</span> <span class="token keyword">in</span> <span class="token variable">$@</span>
    <span class="token keyword">do</span>
        <span class="token comment">#4. 判断文件是否存在</span>
        <span class="token keyword">if</span> <span class="token punctuation">[</span> -e <span class="token variable">$file</span> <span class="token punctuation">]</span>
            <span class="token keyword">then</span>
                <span class="token comment">#5. 获取父目录</span>
                <span class="token assign-left variable">pdir</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token builtin class-name">cd</span> -P <span class="token punctuation">$(</span>dirname $file<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token builtin class-name">pwd</span><span class="token variable">)</span></span>

                <span class="token comment">#6. 获取当前文件的名称</span>
                <span class="token assign-left variable">fname</span><span class="token operator">=</span><span class="token variable"><span class="token variable">$(</span><span class="token function">basename</span> $file<span class="token variable">)</span></span>
                <span class="token function">ssh</span> <span class="token variable">$host</span> <span class="token string">&quot;mkdir -p <span class="token variable">$pdir</span>&quot;</span>
                <span class="token function">rsync</span> -av <span class="token variable">$pdir</span>/<span class="token variable">$fname</span> <span class="token variable">$host</span><span class="token builtin class-name">:</span><span class="token variable">$pdir</span>
            <span class="token keyword">else</span>
                <span class="token builtin class-name">echo</span> <span class="token variable">$file</span> does not exists<span class="token operator">!</span>
        <span class="token keyword">fi</span>
    <span class="token keyword">done</span>
<span class="token keyword">done</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div></li><li><p>在172.18.85.249、172.18.85.250上修改配置文件/root/kafka/config/server.properties中的</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>broker.id<span class="token operator">=</span><span class="token number">2</span> broker.id<span class="token operator">=</span><span class="token number">3</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>注：broker.id 不得重复，整个集群中唯一。</strong></p></li><li><p>配置环境变量</p><ol><li><p>在/etc/profile文件中增加kafka环境变量配置：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token function">vim</span> /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>增加如下内容：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token comment"># KAFKA_HOME</span>
<span class="token builtin class-name">export</span> <span class="token assign-left variable">KAFKA_HOME</span><span class="token operator">=</span>/root/kafka
<span class="token builtin class-name">export</span> <span class="token assign-left variable"><span class="token environment constant">PATH</span></span><span class="token operator">=</span><span class="token environment constant">$PATH</span><span class="token builtin class-name">:</span><span class="token variable">$KAFKA_HOME</span>/bin
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div></li><li><p>刷新环境变量：</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code><span class="token builtin class-name">source</span> /etc/profile
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li><li><p>启动集群</p><ol><li><p>先启动zookeeper集群，再启动kafka</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>./zkServer.start /root/zookeeper/conf/zoo.cfg
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>依次在kafka01、kafka02、kafka03节点上启动kafka</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-server-start.sh -daemon /root/kafka/config/server.properties 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><p><strong>注意：配置文件的路径要能够到 server.properties</strong></p></li><li><p>关闭集群</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-server-stop.sh
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p><strong>注意：关闭集群时要先关闭kafka，再关闭zookeeper集群</strong></p></li></ol><h2 id="_2-2-kafka命令行操作" tabindex="-1"><a class="header-anchor" href="#_2-2-kafka命令行操作" aria-hidden="true">#</a> 2.2 Kafka命令行操作</h2><h3 id="_2-2-1-主题命令行操作" tabindex="-1"><a class="header-anchor" href="#_2-2-1-主题命令行操作" aria-hidden="true">#</a> 2.2.1 主题命令行操作</h3><ol><li><p>查看操作主题命令</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>--bootstrap-server &lt;String: server toconnect to&gt;</td><td>连接的 Kafka Broker 主机名称和端口号</td></tr><tr><td>--topic &lt;String: topic&gt;</td><td>操作的 topic 名称</td></tr><tr><td>--create</td><td>创建主题</td></tr><tr><td>--delete</td><td>删除主题</td></tr><tr><td>--alter</td><td>修改主题</td></tr><tr><td>--list</td><td>查看所有主题</td></tr><tr><td>--describe</td><td>查看主题详细描述</td></tr><tr><td>--partitions &lt;Integer: # of partitions&gt;</td><td>设置分区数</td></tr><tr><td>--replication-factor&lt;Integer: replication factor&gt;</td><td>设置分区副本</td></tr><tr><td>--config &lt;String: name=value&gt;</td><td>更新系统默认的配置</td></tr></tbody></table></li><li><p>查看当前服务器所有的topic</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server kafka01:9092  --list
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>创建 hello topic</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server kafka01:9092 --create --partitions <span class="token number">1</span> --replication-factor <span class="token number">3</span> --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>选项说明：</p><p>--topic 定义 topic 名</p><p>--replication-factor 定义副本数</p><p>--partitions 定义分区数</p></li><li><p>查看 hello 主题的详情</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server kafka01:9092 --describe  --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>Topic: hello    TopicId: yYLpdO8UQL2jWZyFcn0TVA PartitionCount: <span class="token number">1</span>       ReplicationFactor: <span class="token number">3</span>    Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
        Topic: hello    Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0,2</span>,1 Isr: <span class="token number">0,2</span>,1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div></li><li><p>修改分区数（<strong>注意：分区数只能增加，不能减少</strong>）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server kafka01:9092 --alter --partitions <span class="token number">3</span> --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>再次查看 first 主题的详情</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>Topic: hello    TopicId: yYLpdO8UQL2jWZyFcn0TVA PartitionCount: <span class="token number">3</span>       ReplicationFactor: <span class="token number">3</span>    Configs: segment.bytes<span class="token operator">=</span><span class="token number">1073741824</span>
        Topic: hello    Partition: <span class="token number">0</span>    Leader: <span class="token number">0</span>       Replicas: <span class="token number">0,2</span>,1 Isr: <span class="token number">0,2</span>,1
        Topic: hello    Partition: <span class="token number">1</span>    Leader: <span class="token number">1</span>       Replicas: <span class="token number">1,2</span>,0 Isr: <span class="token number">1,2</span>,0
        Topic: hello    Partition: <span class="token number">2</span>    Leader: <span class="token number">2</span>       Replicas: <span class="token number">2,0</span>,1 Isr: <span class="token number">2,0</span>,1
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li><li><p>删除 topic</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-topics.sh --bootstrap-server kafka01:9092 --delete --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="_2-2-2-生产者命令行操作" tabindex="-1"><a class="header-anchor" href="#_2-2-2-生产者命令行操作" aria-hidden="true">#</a> 2.2.2 生产者命令行操作</h3><ol><li><p>查看操作生产者命令参数</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-producer.sh
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>--bootstrap-server &lt;String: server toconnect to&gt;</td><td>连接的 Kafka Broker 主机名称和端口号</td></tr><tr><td>--topic &lt;String: topic&gt;</td><td>操作的 topic 名称</td></tr></tbody></table></li><li><p>发送消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-producer.sh --bootstrap-server kafka01:9092 --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="_2-3-3-消费者命令行操作" tabindex="-1"><a class="header-anchor" href="#_2-3-3-消费者命令行操作" aria-hidden="true">#</a> 2.3.3 消费者命令行操作</h3><ol><li><p>查看操作消费者命令参数</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-consumer.sh 
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>--bootstrap-server &lt;String: server toconnect to&gt;</td><td>连接的 Kafka Broker 主机名称和端口号</td></tr><tr><td>--topic &lt;String: topic&gt;</td><td>操作的 topic 名称</td></tr><tr><td>--from-beginning</td><td>从头开始消费</td></tr><tr><td>--group &lt;String: consumer group id&gt;</td><td>指定消费者组名称</td></tr></tbody></table></li><li><p>消费消息</p><ol><li><p>消费 first 主题中的数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>把主题中所有的数据都读取出来（包括历史数据）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server kafka01:9092 --from-beginning --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h1 id="第三章-kafka生产者" tabindex="-1"><a class="header-anchor" href="#第三章-kafka生产者" aria-hidden="true">#</a> 第三章 Kafka生产者</h1><h2 id="_3-1-生产者发送消息流程" tabindex="-1"><a class="header-anchor" href="#_3-1-生产者发送消息流程" aria-hidden="true">#</a> 3.1 生产者发送消息流程</h2><h3 id="_3-1-1-发送原理" tabindex="-1"><a class="header-anchor" href="#_3-1-1-发送原理" aria-hidden="true">#</a> 3.1.1 发送原理</h3><p>​ 在消息发送的过程中，涉及到了两个线程——<strong>main</strong> 线程和 <strong>Sender</strong> 线程。在 main 线程中创建了一个双端队列 <strong>RecordAccumulator</strong>。main 线程将消息发送给 RecordAccumulator，Sender 线程不断从 RecordAccumulator 中拉取消息发送到 Kafka Broker。</p><h3 id="_3-1-2-生产者重要参数列表" tabindex="-1"><a class="header-anchor" href="#_3-1-2-生产者重要参数列表" aria-hidden="true">#</a> 3.1.2 生产者重要参数列表</h3><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>bootstrap.servers</td><td>生产者连接集群所需的 broker 地址清单.例 如kfaka01:9092，kfaka02:9092，kfaka03:9092，可以设置 1 个或者多个，中间用逗号隔开。注意这里并非需要所有的 broker 地址，因为生产者从给定的 broker里查找到其他 broker 信息。</td></tr><tr><td>key.serializer 和 value.serializer</td><td>指定发送消息的 key 和 value 的序列化类型，<strong>一定要写全类名</strong>。</td></tr><tr><td>buffer.memory</td><td>RecordAccumulator 缓冲区总大小，<strong>默认 32m</strong>。</td></tr><tr><td>batch.size</td><td>缓冲区一批数据最大值，<strong>默认16k</strong>。适当增加该值，可以提高吞吐量，但是如果该值设置太大，会导致数据传输延迟增加。</td></tr><tr><td>linger.ms</td><td>如果数据迟迟未达到 batch.size，sender 等待 linger.time之后就会发送数据。单位 ms，默认值是 0ms，表示没有延迟。<strong>生产环境建议该值大小为 5-100ms 之间</strong>。</td></tr><tr><td>acks</td><td>0：生产者发送过来的数据，<strong>不需要等数据落盘应答</strong>。1：生产者发送过来的数据，<strong>Leader 收到数据后应答</strong>。-1（all）：生产者发送过来的数据，Leader+和 isr 队列里面的所有节点收齐数据后应答。默认值是-1，-1 和all 是等价的。</td></tr><tr><td>max.in.flight.requests.per.connection</td><td>允许最多没有返回 ack 的次数，默认为 5，开启幂等性要保证该值是 1-5 的数字。</td></tr><tr><td>retries</td><td>当消息发送出现错误的时候，系统会重发消息。<strong>retries表示重试次数，默认是 int 最大值，2147483647</strong>。如果设置了重试，还想保证消息的有序性，需要设置MAX_IN_FLIGHT_REQUESTS_PER_CONNECTION=1，否则在重试此失败消息的时候，其他的消息可能发送成功了。</td></tr><tr><td>retry.backoff.ms</td><td>两次重试之间的时间间隔，默认是 100ms。</td></tr><tr><td>enable.idempotence</td><td>是否开启幂等性，默认 true。</td></tr><tr><td>compression.type</td><td>生产者发送的所有数据的压缩方式，<strong>默认是 none，也就是不压缩</strong>。支持压缩类型：<strong>none、gzip、snappy、lz4 和 zstd</strong>。</td></tr></tbody></table><h2 id="_3-2-异步发送api" tabindex="-1"><a class="header-anchor" href="#_3-2-异步发送api" aria-hidden="true">#</a> 3.2 异步发送API</h2><h3 id="_3-2-1-普通异步发送" tabindex="-1"><a class="header-anchor" href="#_3-2-1-普通异步发送" aria-hidden="true">#</a> 3.2.1 普通异步发送</h3><ol><li><p>需求：创建 Kafka 生产者，采用异步的方式发送到 Kafka Broker</p></li><li><p>代码编写</p><ol><li><p>创建maven工程kafka</p></li><li><p>导入依赖</p><div class="language-xml ext-xml line-numbers-mode"><pre class="language-xml"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>dependency</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>groupId</span><span class="token punctuation">&gt;</span></span>org.apache.kafka<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>groupId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>artifactId</span><span class="token punctuation">&gt;</span></span>kafka-clients<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>artifactId</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>version</span><span class="token punctuation">&gt;</span></span>3.0.0<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>version</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>dependency</span><span class="token punctuation">&gt;</span></span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p>创建包：com.kafka.producer</p></li><li><p>编写不带回调函数的异步API</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> cyl
 * <span class="token keyword">@date</span> 2022-02-19 21:06
 * <span class="token keyword">@description</span> kafka不带回调函数异步发送生产者
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducer</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//0.添加配置信息</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置bootstrap.server----</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span><span class="token string">&quot;39.108.62.189:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key、value设置序列化器</span>
        <span class="token comment">//properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1.创建kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.调用send方法，发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3.关闭资源</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br></div></div></li><li><p>测试</p><p>在kafka上开启消费者，成功消费消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h3 id="_3-2-2-带回调函数异步发送" tabindex="-1"><a class="header-anchor" href="#_3-2-2-带回调函数异步发送" aria-hidden="true">#</a> 3.2.2 带回调函数异步发送</h3><p>​ 回调函数会在 producer 收到 ack 时调用，为异步调用，该方法有两个参数，分别是元数据信息（RecordMetadata）和异常信息（Exception），如果 Exception 为 null，说明消息发送成功，如果 Exception 不为 null，说明消息发送失败。</p><p><strong>注意：消息发送失败会自动重试，不需要我们在回调函数中手动重试</strong>。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//2.调用send方法，发送消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//设置回调</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//没有异常</span>
                <span class="token class-name">String</span> topic <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****主题:&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;-&gt;分区:&quot;</span> <span class="token operator">+</span> partition <span class="token operator">+</span> <span class="token string">&quot;*****&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">//延迟一会会看到消息发往不同分区</span>
    <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>测试</p><ol><li><p>在kafka上开启消费者，成功消费消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>kafka-console-consumer.sh --bootstrap-server kafka01:9092 --topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>idea控制台打印</p></li></ol><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">0</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><h2 id="_3-3-同步发送api" tabindex="-1"><a class="header-anchor" href="#_3-3-同步发送api" aria-hidden="true">#</a> 3.3 同步发送API</h2><p><strong>只需在异步发送的基础上，再调用一下 get()方法即可。</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">//2.调用send方法，发送消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//异步发送</span>
    <span class="token comment">//producer.send(new ProducerRecord&lt;&gt;(&quot;hello&quot;,&quot;hello world&quot; + i));</span>
    <span class="token comment">//同步发送</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span><span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>测试</p><p>在kafka上开启消费者，成功消费消息</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>kafka<span class="token operator">-</span>console<span class="token operator">-</span>consumer<span class="token punctuation">.</span>sh <span class="token operator">--</span>bootstrap<span class="token operator">-</span>server kafka01<span class="token operator">:</span><span class="token number">9092</span> <span class="token operator">--</span>topic hello
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div><h2 id="_3-4-生产者分区" tabindex="-1"><a class="header-anchor" href="#_3-4-生产者分区" aria-hidden="true">#</a> 3.4 生产者分区</h2><h3 id="_3-4-1-分区的好处" tabindex="-1"><a class="header-anchor" href="#_3-4-1-分区的好处" aria-hidden="true">#</a> 3.4.1 分区的好处</h3><ol><li><p><strong>便于合理使用存储资源</strong>，每个Partition在一个Broker上存储，可以把海量的数据按照分区切割成一块一块数据存储在多台Broker上。合理控制分区的任务，可以实现<strong>负载均衡</strong>的效果。</p></li><li><p><strong>提高并行度</strong>，生产者可以<strong>以分区为单位发送数据</strong>；消费者可以<strong>以分区为单位进行消费数据</strong>。</p></li></ol><h3 id="_3-4-2-分区策略" tabindex="-1"><a class="header-anchor" href="#_3-4-2-分区策略" aria-hidden="true">#</a> 3.4.2 分区策略</h3><ol><li><p><strong>默认的分区器DefaultPartitioner</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">DefaultPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">StickyPartitionCache</span> stickyPartitionCache <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">StickyPartitionCache</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token class-name">DefaultPartitioner</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> configs<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> key<span class="token punctuation">,</span> keyBytes<span class="token punctuation">,</span> value<span class="token punctuation">,</span> valueBytes<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> cluster<span class="token punctuation">.</span><span class="token function">partitionsForTopic</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Object</span> key<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> keyBytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> value<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> valueBytes<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">int</span> numPartitions<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> keyBytes <span class="token operator">==</span> <span class="token keyword">null</span> <span class="token operator">?</span> <span class="token keyword">this</span><span class="token punctuation">.</span>stickyPartitionCache<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">)</span> <span class="token operator">:</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">toPositive</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">murmur2</span><span class="token punctuation">(</span>keyBytes<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">%</span> numPartitions<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onNewBatch</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">,</span> <span class="token keyword">int</span> prevPartition<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>stickyPartitionCache<span class="token punctuation">.</span><span class="token function">nextPartition</span><span class="token punctuation">(</span>topic<span class="token punctuation">,</span> cluster<span class="token punctuation">,</span> prevPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div><p>ProducerRecord类，在类中可以看到如下构造方法：</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//指明partition的情况下，直接将指明的值作为partition值；例如partition=0，所有数据写入分区0</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span><span class="token punctuation">&gt;</span></span> headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">Long</span> timestamp<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">,</span> <span class="token class-name">Iterable</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Header</span><span class="token punctuation">&gt;</span></span> headers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">Integer</span> partition<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">//没有指明partition值但有key的情况下，将key的hash值与topic的partition数进行取余得到partition值；</span>
<span class="token comment">//例如：key1的hash值=5， key2的hash值=6 ，topic的partition数=2，那 么key1 对应的value1写入1号分区，key2对应的value2写入0号分区</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">K</span> key<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
<span class="token comment">//既没有partition值又没有key值的情况下，Kafka采用Sticky Partition（黏性分区器），会随机选择一个分区，并尽可能一直使用该分区，待该分区的batch已满</span>
<span class="token comment">//或者已完成，Kafka再随机一个分区进行使用（和上一次的分区不同）。</span>
<span class="token comment">//例如：第一次随机选择0号分区，等0号分区当前批次满了（默认16k）或者linger.ms设置的时间到， Kafka再随机一个分区进行使用（如果还是0会继续随机）</span>
<span class="token keyword">public</span> <span class="token class-name">ProducerRecord</span><span class="token punctuation">(</span><span class="token class-name">String</span> topic<span class="token punctuation">,</span> <span class="token class-name">V</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
<span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br></div></div></li><li><p><strong>案例一</strong></p><p><strong>将数据发往指定 partition 的情况下</strong>，例如，将所有数据发往分区 1 中。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">//2.调用send()方法，发送消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token comment">//指定发送数据到1号分区</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//没有异常</span>
                <span class="token class-name">String</span> topic <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****主题:&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;-&gt;分区:&quot;</span> <span class="token operator">+</span> partition <span class="token operator">+</span> <span class="token string">&quot;*****&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>测试</p><p>idea控制台打印</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li><li><p><strong>案例二</strong></p><p><strong>没有指明 partition 值但有 key 的情况下</strong>，将 key 的 hash 值与 topic 的 partition 数进行<strong>取余</strong>得到 partition 值。</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">// 依次指定 key 值为 a,b,f ，数据 key 的 hash 值与 3 个分区求余，分别发往 1、2、0</span>
producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token string">&quot;a&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//没有异常</span>
            <span class="token class-name">String</span> topic <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">int</span> partition <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****主题:&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;-&gt;分区:&quot;</span> <span class="token operator">+</span> partition <span class="token operator">+</span> <span class="token string">&quot;*****&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>测试</p><p>idea控制台打印</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol><h3 id="_3-4-3-自定义分区器" tabindex="-1"><a class="header-anchor" href="#_3-4-3-自定义分区器" aria-hidden="true">#</a> 3.4.3 自定义分区器</h3><p>​ 如果研发人员可以根据企业需求，自己重新实现分区器。</p><ol><li><p>需求</p><p>例如我们实现一个分区器实现，发送过来的数据中如果包含hello，就发往0号分区，不包含hello，就发往1号分区。</p></li><li><p>实现步骤</p><ol><li><p>定义类实现 Partitioner 接口</p></li><li><p>重写 partition()方法</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">Partitioner</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span></span><span class="token class-name">Cluster</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Map</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> cyl
 * <span class="token keyword">@date</span> 2022-02-20 13:21
 * <span class="token keyword">@description</span> 自定义分区器
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomPartitioner</span> <span class="token keyword">implements</span> <span class="token class-name">Partitioner</span> <span class="token punctuation">{</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">partition</span><span class="token punctuation">(</span><span class="token class-name">String</span> s<span class="token punctuation">,</span> <span class="token class-name">Object</span> o<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes<span class="token punctuation">,</span> <span class="token class-name">Object</span> o1<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes1<span class="token punctuation">,</span> <span class="token class-name">Cluster</span> cluster<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//1.获取消息</span>
        <span class="token class-name">String</span> value <span class="token operator">=</span> o1<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.创建partition</span>
        <span class="token keyword">int</span> partition<span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span>value<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            partition <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> partition<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">configure</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token operator">?</span><span class="token punctuation">&gt;</span></span> map<span class="token punctuation">)</span> <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br></div></div></li><li><p>使用分区器的方法，在生产者的配置中添加分区器参数</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">//指定分区器为自定义分区器</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>PARTITIONER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">CustomPartitioner</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//1.创建生产者对象</span>
<span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">//2.调用send()方法，发送消息</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">,</span> <span class="token string">&quot;world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">Callback</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">onCompletion</span><span class="token punctuation">(</span><span class="token class-name">RecordMetadata</span> recordMetadata<span class="token punctuation">,</span> <span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>e <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//没有异常</span>
                <span class="token class-name">String</span> topic <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">int</span> partition <span class="token operator">=</span> recordMetadata<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;****主题:&quot;</span> <span class="token operator">+</span> topic <span class="token operator">+</span> <span class="token string">&quot;-&gt;分区:&quot;</span> <span class="token operator">+</span> partition <span class="token operator">+</span> <span class="token string">&quot;*****&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br></div></div></li><li><p>测试</p><p>idea控制台打印</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
<span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>主题<span class="token operator">:</span>hello<span class="token operator">-&gt;</span>分区<span class="token operator">:</span><span class="token number">1</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span><span class="token operator">*</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div></li></ol></li></ol><h2 id="_3-5-生产者提高吞吐量" tabindex="-1"><a class="header-anchor" href="#_3-5-生产者提高吞吐量" aria-hidden="true">#</a> 3.5 生产者提高吞吐量</h2><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> cyl
 * <span class="token keyword">@date</span> 2022-02-20 13:37
 * <span class="token keyword">@description</span> kafka生产者提高吞吐量
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerParameters</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//0.配置连接信息等</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置bootstrap.server</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;120.25.193.19:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置key序列化器</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//配置value序列化器</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//设置批次大小，默认:16k</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BATCH_SIZE_CONFIG<span class="token punctuation">,</span> <span class="token number">16384</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//等待事件，默认:0</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>LINGER_MS_CONFIG<span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//缓冲区大小，默认:32M</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BUFFER_MEMORY_CONFIG<span class="token punctuation">,</span> <span class="token number">33554432</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//压缩，默认:none，可配置gzip、snappy、lz4 和 zstd</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>COMPRESSION_TYPE_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;snappy&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1.创建生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.调用send()方法，发送消息</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//3.关闭资源</span>
        producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br></div></div><h2 id="_3-6-数据可靠性" tabindex="-1"><a class="header-anchor" href="#_3-6-数据可靠性" aria-hidden="true">#</a> 3.6 数据可靠性</h2><ol><li><p>回顾发送流程</p></li><li><p>ack应答原理</p><p><strong>数据完全可靠条件 = ACK级别设置为-1 + 分区副本大于等于2 + ISR里应答的最小副本数量大于等于2</strong></p><p><strong>可靠性总结：</strong></p><ul><li><p>acks=0，生产者发送过来数据就不管了，可靠性差，效率高；</p></li><li><p>acks=1，生产者发送过来数据Leader应答，可靠性中等，效率中等；</p></li><li><p>acks=-1，生产者发送过来数据Leader和ISR队列里面所有Follwer应答，可靠性高，效率低； <strong>在生产环境中，acks=0很少使用；acks=1，一般用于传输普通日志，允许丢个别数据；acks=-1，一般用于传输和钱相关的数据，</strong><strong>对可靠性要求比较高的场景。</strong></p><p><strong>数据重复分析：</strong></p><p><strong>acks： -1（all）：生产者发送过来的数据，Leader和ISR队列里面的所有节点收齐数据后应答。</strong></p></li></ul></li><li><p>代码</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">//设置acks</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>ACKS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;all&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//设置重试次数，默认:int的最大值 2147483647</span>
properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>RETRIES_CONFIG<span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div></li></ol><h2 id="_3-7-数据去重" tabindex="-1"><a class="header-anchor" href="#_3-7-数据去重" aria-hidden="true">#</a> 3.7 数据去重</h2><h3 id="_3-7-1-数据传递语义" tabindex="-1"><a class="header-anchor" href="#_3-7-1-数据传递语义" aria-hidden="true">#</a> 3.7.1 数据传递语义</h3><ul><li><p><strong>至少一次</strong>（At Least Once）= ACK级别设置为-1 + 分区副本大于等于2 + ISR里应答的最小副本数量大于等于2</p></li><li><p><strong>最多一次</strong>（At Most Once）= ACK级别设置为0</p></li><li><p><strong>总结：</strong> At Least Once可以保证数据不丢失，但是<strong>不能保证数据不重复</strong>； At Most Once可以保证数据不重复，但是<strong>不能保证数据不丢失</strong>。</p></li><li><p><strong>精确一次</strong>（Exactly Once）：对于一些非常重要的信息，比如和钱相关的数据，要求数据既不能重复也不丢失。</p><p>Kafka 0.11版本以后，引入了一项重大特性：<strong>幂等性和事务</strong>。</p></li></ul><h3 id="_3-7-2-幂等性" tabindex="-1"><a class="header-anchor" href="#_3-7-2-幂等性" aria-hidden="true">#</a> 3.7.2 幂等性</h3><ol><li><p><strong>幂等性原理</strong></p><p><strong>幂等性</strong>就是指Producer不论向Broker发送多少次重复数据，<strong>Broker端都只会持久化一条，保证了不重复</strong>。 <strong>精确一次（Exactly Once） = 幂等性 + 至少一次（ ack=-1 + 分区副本数&gt;=2 + ISR最小副本数量&gt;=2</strong>） 。 <strong>重复数据的判断标准</strong>：具有&lt;<strong>PID</strong>, <strong>Partition</strong>, <strong>SeqNumber</strong>&gt;相同主键的消息提交时，Broker只会持久化一条。其 中PID是Kafka每次重启都会分配一个新的；Partition 表示分区号；Sequence Number是单调自增的。 所以幂等性只能保证的是在<strong>单分区单会话内</strong>不重复。</p></li><li><p><strong>如何使用幂等性</strong></p><p>开启参数 <strong>enable.idempotence</strong> 默认为 true，false 关闭。</p></li></ol><h3 id="_3-7-3-事务" tabindex="-1"><a class="header-anchor" href="#_3-7-3-事务" aria-hidden="true">#</a> 3.7.3 事务</h3><ol><li><p>事务原理</p><p><strong>说明：开启事务，必须开启幂等性。</strong></p></li><li><p><strong>事务API</strong></p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">// 1 初始化事务</span>
<span class="token keyword">void</span> <span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// 2 开启事务</span>
<span class="token keyword">void</span> <span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span class="token comment">// 3 在事务内提交已经消费的偏移量（主要用于消费者）</span>
<span class="token keyword">void</span> <span class="token function">sendOffsetsToTransaction</span><span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">OffsetAndMetadata</span><span class="token punctuation">&gt;</span></span> offsets<span class="token punctuation">,</span>
 <span class="token class-name">String</span> consumerGroupId<span class="token punctuation">)</span> <span class="token keyword">throws</span> 
<span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span class="token comment">// 4 提交事务</span>
<span class="token keyword">void</span> <span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
<span class="token comment">// 5 放弃事务（类似于回滚事务的操作）</span>
<span class="token keyword">void</span> <span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">ProducerFencedException</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div></li><li><p>单个 Producer，使用事务保证消息的仅一次发送</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">package</span> <span class="token namespace">com<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>producer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">KafkaProducer</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerConfig</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>clients<span class="token punctuation">.</span>producer<span class="token punctuation">.</span></span><span class="token class-name">ProducerRecord</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> <span class="token namespace">org<span class="token punctuation">.</span>apache<span class="token punctuation">.</span>kafka<span class="token punctuation">.</span>common<span class="token punctuation">.</span>serialization<span class="token punctuation">.</span></span><span class="token class-name">StringSerializer</span><span class="token punctuation">;</span>

<span class="token keyword">import</span> <span class="token namespace">java<span class="token punctuation">.</span>util<span class="token punctuation">.</span></span><span class="token class-name">Properties</span><span class="token punctuation">;</span>

<span class="token doc-comment comment">/**
 * <span class="token keyword">@author</span> cyl
 * <span class="token keyword">@date</span> 2022-02-19 21:06
 * <span class="token keyword">@description</span> kafka生产者事务
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomProducerTransaction</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>

        <span class="token comment">//0.添加配置信息</span>
        <span class="token class-name">Properties</span> properties <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Properties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//配置bootstrap.server----</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>BOOTSTRAP_SERVERS_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;120.25.193.19:9092&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//key、value设置序列化器</span>
        <span class="token comment">//properties.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>KEY_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>VALUE_SERIALIZER_CLASS_CONFIG<span class="token punctuation">,</span> <span class="token class-name">StringSerializer</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//事务id，一定要设置且全局唯一</span>
        properties<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span><span class="token class-name">ProducerConfig</span><span class="token punctuation">.</span>TRANSACTIONAL_ID_CONFIG<span class="token punctuation">,</span> <span class="token string">&quot;transaction_id_0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//1.创建kafka生产者对象</span>
        <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> producer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">KafkaProducer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>properties<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//初始化事务</span>
        producer<span class="token punctuation">.</span><span class="token function">initTransactions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//开启事务</span>
        producer<span class="token punctuation">.</span><span class="token function">beginTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//2.调用send方法，发送消息</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span> i <span class="token operator">&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span> i<span class="token operator">++</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                producer<span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ProducerRecord</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;hello world&quot;</span> <span class="token operator">+</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            
			<span class="token comment">//int i = 10 / 0;</span>
            <span class="token comment">//提交事务</span>
            producer<span class="token punctuation">.</span><span class="token function">commitTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            e<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//终止事务</span>
            producer<span class="token punctuation">.</span><span class="token function">abortTransaction</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>

            <span class="token comment">//3.关闭资源</span>
            producer<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>


    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div></li></ol><h2 id="_3-8-数据有序" tabindex="-1"><a class="header-anchor" href="#_3-8-数据有序" aria-hidden="true">#</a> 3.8 数据有序</h2><h2 id="_3-9-数据乱序" tabindex="-1"><a class="header-anchor" href="#_3-9-数据乱序" aria-hidden="true">#</a> 3.9 数据乱序</h2><ol><li><p>kafka在<strong>1.x版本之前</strong>保证数据单分区有序，条件如下：</p><p><strong>max.in.flight.requests.per.connection=1（不需要考虑是否开启幂等性）</strong></p></li><li><p>kafka在<strong>1.x及以后版本</strong>保证数据单分区有序，条件如下：</p><ol><li><p>未开启幂等性</p><p><strong>max.in.flight.requests.per.connection需要设置为1</strong></p></li><li><p>开启幂等性</p><p><strong>max.in.flight.requests.per.connection需要设置小于等于5</strong> 原因说明：因为在kafka1.x以后，启用幂等后，kafka服务端会缓存producer发来的最近5个request的元数据，故无论如何，都可以保证最近5个request的数据都是有序的。</p></li></ol></li></ol><h1 id="第四章-kafka-broker" tabindex="-1"><a class="header-anchor" href="#第四章-kafka-broker" aria-hidden="true">#</a> 第四章 Kafka Broker</h1><h2 id="_4-1-broker工作流程" tabindex="-1"><a class="header-anchor" href="#_4-1-broker工作流程" aria-hidden="true">#</a> 4.1 Broker工作流程</h2><h3 id="_4-1-1-zookeeper存储的kafka信息" tabindex="-1"><a class="header-anchor" href="#_4-1-1-zookeeper存储的kafka信息" aria-hidden="true">#</a> 4.1.1 Zookeeper存储的Kafka信息</h3><ol><li><p>启动zookeeper客户端</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>通过ls命令查看Kafka相关信息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code></code></pre><div class="line-numbers" aria-hidden="true"></div></div></li></ol><h3 id="_4-1-2-broker总体工作流程" tabindex="-1"><a class="header-anchor" href="#_4-1-2-broker总体工作流程" aria-hidden="true">#</a> 4.1.2 Broker总体工作流程</h3><ol><li><p>模拟 Kafka 上下线，Zookeeper 中数据变化</p><ol><li><p>查看/kafka/brokers/ids 路径上的节点</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看/kafka/controller 路径上的数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>停止 kafka03 上的 kafka</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>再次查看/kafka/brokers/ids 路径上的节点</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>再次查看/kafka/controller 路径上的数据</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>再次查看/kafka/brokers/topics/first/partitions/0/state 路径上的数据</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>启动 kafka03 上的 kafka</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h3 id="_4-1-3-broker重要参数" tabindex="-1"><a class="header-anchor" href="#_4-1-3-broker重要参数" aria-hidden="true">#</a> 4.1.3 Broker重要参数</h3><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>replica.lag.time.max.ms</td><td>ISR 中，如果 Follower 长时间未向 Leader 发送通信请求或同步数据，则该 Follower 将被踢出 ISR。该时间阈值，默认 30s。</td></tr><tr><td>auto.leader.rebalance.enable</td><td>默认是 true。 自动 Leader Partition 平衡。</td></tr><tr><td>leader.imbalance.per.broker.percentage</td><td>默认是 10%。每个 broker 允许的不平衡的 leader的比率。如果每个 broker 超过了这个值，控制器会触发 leader 的平衡。</td></tr><tr><td>leader.imbalance.check.interval.seconds</td><td>默认值 300 秒。检查 leader 负载是否平衡的间隔时间。</td></tr><tr><td>log.segment.bytes</td><td>Kafka 中 log 日志是分成一块块存储的，此配置是指 log 日志划分 成块的大小，默认值 1G。</td></tr><tr><td>log.index.interval.bytes</td><td>默认 4kb，kafka 里面每当写入了 4kb 大小的日志（.log），然后就往 index 文件里面记录一个索引。</td></tr><tr><td>log.retention.hours</td><td>Kafka 中数据保存的时间，默认 7 天。</td></tr><tr><td>log.retention.minutes</td><td>Kafka 中数据保存的时间，分钟级别，默认关闭。</td></tr><tr><td>log.retention.ms</td><td>Kafka 中数据保存的时间，毫秒级别，默认关闭。</td></tr><tr><td>log.retention.check.interval.ms</td><td>检查数据是否保存超时的间隔，默认是 5 分钟。</td></tr><tr><td>log.retention.bytes</td><td>默认等于-1，表示无穷大。超过设置的所有日志总大小，删除最早的 segment。</td></tr><tr><td>log.cleanup.policy</td><td>默认是 delete，表示所有数据启用删除策略；如果设置值为 compact，表示所有数据启用压缩策略。</td></tr><tr><td>num.io.threads</td><td>默认是 8。负责写磁盘的线程数。整个参数值要占总核数的 50%。</td></tr><tr><td>num.replica.fetchers</td><td>副本拉取线程数，这个参数占总核数的 50%的 1/3</td></tr><tr><td>num.network.threads</td><td>默认是 3。数据传输线程数，这个参数占总核数的50%的 2/3 。</td></tr><tr><td>log.flush.interval.messages</td><td>强制页缓存刷写到磁盘的条数，默认是 long 的最大值，9223372036854775807。一般不建议修改，交给系统自己管理。</td></tr><tr><td>log.flush.interval.ms</td><td>每隔多久，刷数据到磁盘，默认是 null。一般不建议修改，交给系统自己管理。</td></tr></tbody></table><h2 id="_4-2-节点服役和退役" tabindex="-1"><a class="header-anchor" href="#_4-2-节点服役和退役" aria-hidden="true">#</a> 4.2 节点服役和退役</h2><h3 id="_4-2-1-服役新节点" tabindex="-1"><a class="header-anchor" href="#_4-2-1-服役新节点" aria-hidden="true">#</a> 4.2.1 服役新节点</h3><ol><li><p>准备新节点</p></li><li><p>执行负载均衡操作</p><ol><li><p>创建一个要均衡的主题</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>生成一个负载均衡的计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>创建副本存储计划（所有副本存储在 broker0、broker1、broker2、broker3 中）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>执行副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>验证副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h3 id="_4-2-2-退役旧节点" tabindex="-1"><a class="header-anchor" href="#_4-2-2-退役旧节点" aria-hidden="true">#</a> 4.2.2 退役旧节点</h3><ol><li><p>执行负载均衡操作</p><p>先按照退役一台节点，生成执行计划，然后按照服役时操作流程执行负载均衡。</p><ol><li><p>创建一个要均衡的主题</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>创建执行计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>创建副本存储计划（所有副本存储在 broker0、broker1、broker2 中）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>执行副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>验证副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li><li><p>执行停止命令</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h2 id="_4-3-kafka副本" tabindex="-1"><a class="header-anchor" href="#_4-3-kafka副本" aria-hidden="true">#</a> 4.3 Kafka副本</h2><h3 id="_4-3-1-副本基本信息" tabindex="-1"><a class="header-anchor" href="#_4-3-1-副本基本信息" aria-hidden="true">#</a> 4.3.1 副本基本信息</h3><ol><li>Kafka 副本作用：提高数据可靠性。</li><li>Kafka 默认副本 1 个，生产环境一般配置为 2 个，保证数据可靠性；太多副本会增加磁盘存储空间，增加网络上数据传输，降低效率。</li><li>Kafka 中副本分为：Leader 和 Follower。Kafka 生产者只会把数据发往 Leader，然后 Follower 找 Leader 进行同步数据。</li><li>Kafka 分区中的所有副本统称为 AR（Assigned Repllicas）。 <strong>AR = ISR + OSR</strong> **ISR：**表示和 Leader 保持同步的 Follower 集合。如果 Follower 长时间未向 Leader 发送通信请求或同步数据，则该 Follower 将被踢出 ISR。该时间阈值由 replica.lag.time.max.ms参数设定，默认 30s。Leader 发生故障之后，就会从 ISR 中选举新的 Leader。 **OSR：**表示 Follower 与 Leader 副本同步时，延迟过多的副本。</li></ol><h3 id="_4-3-2-leader选举流程" tabindex="-1"><a class="header-anchor" href="#_4-3-2-leader选举流程" aria-hidden="true">#</a> 4.3.2 Leader选举流程</h3><p>​ Kafka 集群中有一个 broker 的 Controller 会被选举为 Controller Leader，负责管理集群broker 的上下线，所有 topic 的分区副本分配和 Leader 选举等工作。 ​ Controller 的信息同步工作是依赖于 Zookeeper 的。</p><ol><li><p>创建一个新的 topic，4 个分区，4 个副本</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看 Leader 分布情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>停止掉 hadoop105 的 kafka 进程，并查看 Leader 分区情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>停止掉 hadoop104 的 kafka 进程，并查看 Leader 分区情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>启动 hadoop105 的 kafka 进程，并查看 Leader 分区情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>启动 hadoop104 的 kafka 进程，并查看 Leader 分区情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>停止掉 hadoop103 的 kafka 进程，并查看 Leader 分区情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="_4-3-3-leader和follower故障处理细节" tabindex="-1"><a class="header-anchor" href="#_4-3-3-leader和follower故障处理细节" aria-hidden="true">#</a> 4.3.3 Leader和Follower故障处理细节</h3><p><strong>LEO（Log End Offset）</strong>：每个副本的最后一个offset，LEO其实就是最新的offset + 1。 <strong>HW（High Watermark）</strong>：所有副本中最小的LEO 。</p><ol><li><p>Follower故障</p><ol><li><p>Follower发生故障后会被临时踢出ISR</p></li><li><p>这个期间Leader和Follower继续接收数据</p></li><li><p>待该Follower恢复后，Follower会读取本地磁盘记录的上次的HW，并将log文件高于HW的部分截取掉，从HW开始 向Leader进行同步</p></li><li><p>等该Follower的LEO大于等于该Partition的HW，即Follower追上Leader之后，就可以重新加入ISR了。</p></li></ol></li><li><p>Leader故障</p><ol><li><p>Leader发生故障之后，会从ISR中选出一个新的Leader</p></li><li><p>为保证多个副本之间的数据一致性，其余的Follower会先将各自的log文件高于HW的部分截掉，然后从新的Leader同步 数据。 <strong>注意：这只能保证副本之间的数据一致性，并不能保证数据不丢失或者不重复。</strong></p></li></ol></li></ol><h3 id="_4-3-4-分区副本分配" tabindex="-1"><a class="header-anchor" href="#_4-3-4-分区副本分配" aria-hidden="true">#</a> 4.3.4 分区副本分配</h3><p>​ 如果 kafka 服务器只有 4 个节点，那么设置 kafka 的分区数大于服务器台数，在 kafka底层如何分配存储副本呢？</p><ol><li><p>创建 16 分区，3 个副本</p><ol><li><p>创建一个新的 topic，名称为 second</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看分区和副本情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h3 id="_4-3-5-手动调整分区副本存储" tabindex="-1"><a class="header-anchor" href="#_4-3-5-手动调整分区副本存储" aria-hidden="true">#</a> 4.3.5 手动调整分区副本存储</h3><p>​ 在生产环境中，每台服务器的配置和性能不一致，但是Kafka只会根据自己的代码规则创建对应的分区副本，就会导致个别服务器存储压力较大。所有需要手动调整分区副本的存储。</p><p>​ 需求：创建一个新的topic，4个分区，两个副本，名称为three。将 该topic的所有副本都存储到broker0和broker1两台服务器上。</p><p>​ 手动调整分区副本存储的步骤如下：</p><ol><li><p>创建一个新的 topic，名称为 three</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看分区副本存储情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>创建副本存储计划（所有副本都指定存储在 broker0、broker1 中）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>执行副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>验证副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看分区副本存储情况</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol><h3 id="_4-3-6-leader-partition负载均衡" tabindex="-1"><a class="header-anchor" href="#_4-3-6-leader-partition负载均衡" aria-hidden="true">#</a> 4.3.6 Leader Partition负载均衡</h3><p>​ 正常情况下，Kafka本身会自动把Leader Partition均匀分散在各个机器上，来保证每台机器的读写吞吐量都是均匀的。但是如果某 些broker宕机，会导致Leader Partition过于集中在其他少部分几台broker上，这会导致少数几台broker的读写请求压力过高，其他宕机的 broker重启之后都是follower partition，读写请求很低，造成集群负载不均衡。</p><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>auto.leader.rebalance.enable</td><td>默认是 true。 自动 Leader Partition 平衡。生产环境中，leader 重选举的代价比较大，可能会带来性能影响，建议设置为 false 关闭。</td></tr><tr><td>leader.imbalance.per.broker.percentage</td><td>默认是 10%。每个 broker 允许的不平衡的 leader的比率。如果每个 broker 超过了这个值，控制器会触发 leader 的平衡。</td></tr><tr><td>leader.imbalance.check.interval.seconds</td><td>默认值 300 秒。检查 leader 负载是否平衡的间隔</td></tr></tbody></table><h3 id="_4-3-7-增加副本因子" tabindex="-1"><a class="header-anchor" href="#_4-3-7-增加副本因子" aria-hidden="true">#</a> 4.3.7 增加副本因子</h3><p>​ 生产环境当中，由于某个主题的重要等级需要提升，我们考虑增加副本。副本数的增加需要先制定计划，然后根据计划执行。</p><ol><li><p>创建 topic</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>手动增加副本存储</p><ol><li><p>创建副本存储计划（所有副本都指定存储在 broker0、broker1、broker2 中）</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>执行副本存储计划</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li></ol><h2 id="_4-4-文件存储" tabindex="-1"><a class="header-anchor" href="#_4-4-文件存储" aria-hidden="true">#</a> 4.4 文件存储</h2><h3 id="_4-4-1-文件存储机制" tabindex="-1"><a class="header-anchor" href="#_4-4-1-文件存储机制" aria-hidden="true">#</a> 4.4.1 文件存储机制</h3><ol><li><p>Topic数据的存储机制</p><p>Topic是逻辑上的概念，而partition是物理上的概念，每个partition对应于一个log文件，该log文件中存储的就是Producer生产的数 据。Producer生产的数据会被不断追加到该log文件末端，为防止log文件过大导致数据定位效率低下，Kafka采取了分片和索引机制， 将每个partition分为多个segment。每个segment包括：“.index”文件、“.log”文件和.timeindex等文件。这些文件位于一个文件夹下，该文件夹的命名规则为：topic名称+分区序号，例如：first-0。</p></li><li><p>思考：Topic 数据到底存储在什么位置？</p><ol><li><p>启动生产者，并发送消息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>查看 hadoop102（或者 hadoop103、hadoop104）的/opt/module/kafka/datas/first-1 （first-0、first-2）路径上的文件</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>直接查看 log 日志</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>通过工具查看 index 和 log 信息</p><div class="language-bash ext-sh line-numbers-mode"><pre class="language-bash"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li></ol></li><li><p>index 文件和 log 文件详解</p></li></ol><p>说明：日志存储参数配置</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>log.segment.bytes</td><td>Kafka 中 log 日志是分成一块块存储的，此配置是指 log 日志划分成块的大小，默认值 1G。</td></tr><tr><td>log.index.interval.bytes</td><td>默认 4kb，kafka 里面每当写入了 4kb 大小的日志（.log），然后就往 index 文件里面记录一个索引。 稀疏索引。</td></tr></tbody></table><h3 id="_4-4-2-文件清理策略" tabindex="-1"><a class="header-anchor" href="#_4-4-2-文件清理策略" aria-hidden="true">#</a> 4.4.2 文件清理策略</h3><p>Kafka 中默认的日志保存时间为 7 天，可以通过调整如下参数修改保存时间。</p><ul><li><p>log.retention.hours，最低优先级小时，默认 7 天。</p></li><li><p>log.retention.minutes，分钟。</p></li><li><p>log.retention.ms，最高优先级毫秒。</p></li><li><p>log.retention.check.interval.ms，负责设置检查周期，默认 5 分钟。</p></li></ul><p>那么日志一旦超过了设置的时间，怎么处理呢？</p><p>Kafka 中提供的日志清理策略有 <strong>delete</strong> 和 <strong>compact</strong> 两种</p><ol><li><p>delete 日志删除：将过期数据删除</p><ul><li><p>log.cleanup.policy = delete 所有数据启用删除策略</p><ol><li><p>基于时间：默认打开。以 segment 中所有记录中的最大时间戳作为该文件时间戳。</p></li><li><p>基于大小：默认关闭。超过设置的所有日志总大小，删除最早的 segment。</p><p>log.retention.bytes，默认等于-1，表示无穷大。</p></li></ol></li></ul></li><li><p>compact 日志压缩</p><p>compact日志压缩：对于相同key的不同value值，只保留最后一个版本。</p><ul><li><p>log.cleanup.policy = compact 所有数据启用压缩策略</p></li></ul><p>压缩后的offset可能是不连续的，比如上图中没有6，当从这些offset消费消息时，将会拿到比这个offset大 的offset对应的消息，实际上会拿到offset为7的消息，并从这个位置开始消费。</p><p>这种策略只适合特殊场景，比如消息的key是用户ID，value是用户的资料，通过这种压缩策略，整个消息 集里就保存了所有用户最新的资料。</p></li></ol><h2 id="_4-5-高效读写数据" tabindex="-1"><a class="header-anchor" href="#_4-5-高效读写数据" aria-hidden="true">#</a> 4.5 高效读写数据</h2><ol><li><p>Kafka 本身是分布式集群，可以采用分区技术，并行度高</p></li><li><p>读数据采用稀疏索引，可以快速定位要消费的数据</p></li><li><p>顺序写磁盘</p><p>Kafka 的 producer 生产数据，要写入到 log 文件中，写的过程是一直追加到文件末端，为顺序写。官网有数据表明，同样的磁盘，顺序写能到 600M/s，而随机写只有 100K/s。这与磁盘的机械机构有关，顺序写之所以快，是因为其省去了大量磁头寻址的时间。</p></li><li><p>页缓存 + 零拷贝技术</p><p>零拷贝：Kafka的数据加工处理操作交由Kafka生产者和Kafka消费者处理。Kafka Broker应用层不关心存储的数据，所以就不用 走应用层，传输效率高。 PageCache页缓存：Kafka重度依赖底层操作系统提供的PageCache功 能。当上层有写操作时，操作系统只是将数据写PageCache。当读操作发生时，先从PageCache中查找，如果找不到，再去磁盘中读取。实际上PageCache是把尽可能多的空闲内存都当做了磁盘缓存来使用。</p><table><thead><tr><th>参数</th><th>描述</th></tr></thead><tbody><tr><td>log.flush.interval.messages</td><td>强制页缓存刷写到磁盘的条数，默认是 long 的最大值，9223372036854775807。一般不建议修改，交给系统自己管理。</td></tr><tr><td>log.flush.interval.ms</td><td>每隔多久，刷数据到磁盘，默认是 null。一般不建议修改，交给系统自己管理。</td></tr></tbody></table></li></ol><h1 id="第五章-kafka消费者" tabindex="-1"><a class="header-anchor" href="#第五章-kafka消费者" aria-hidden="true">#</a> 第五章 Kafka消费者</h1><h2 id="_5-1-kafka消费方式" tabindex="-1"><a class="header-anchor" href="#_5-1-kafka消费方式" aria-hidden="true">#</a> 5.1 Kafka消费方式</h2><ol><li><p>pull（拉）模式：</p><p>consumer采用从broker中主动拉取数据，<strong>Kafka采用这种方式</strong>。</p></li><li><p>push（推）模式：</p><p>Kafka没有采用这种方式，因为由broker决定消息发送速率，很难适应所有消费者的消费速率。如下图所示，例如推送的速度50m/s，Consumer1、Consumer2就来不及处理消息。pull模式不足之处是，如 果Kafka没有数据，消费者可能会陷入循环中，一直返回空数据。</p></li></ol><h2 id="_5-2-kafka消费者工作流程" tabindex="-1"><a class="header-anchor" href="#_5-2-kafka消费者工作流程" aria-hidden="true">#</a> 5.2 Kafka消费者工作流程</h2><h3 id="_5-2-1-消费者总体工作流程" tabindex="-1"><a class="header-anchor" href="#_5-2-1-消费者总体工作流程" aria-hidden="true">#</a> 5.2.1 消费者总体工作流程</h3><h3 id="_5-2-2-消费者组原理" tabindex="-1"><a class="header-anchor" href="#_5-2-2-消费者组原理" aria-hidden="true">#</a> 5.2.2 消费者组原理</h3><ol><li><p>Consumer Group（CG）：消费者组，由多个consumer组成。形成一个消费者组的条件，是所有消费者的groupid相同。</p><ul><li>消费者组内每个消费者负责消费不同分区的数据，一个分区只能由一个组内消费者消费。</li><li>消费者组之间互不影响。所有的消费者都属于某个消费者组，即消费者组是逻辑上的一个订阅者。</li><li>如果向消费组中添加更多的消费者，超过主题分区数量，则有一部分消费者就会闲置，不会接收任何消息。</li></ul></li><li><p>消费者组初始化流程</p><p>coordinator：辅助实现消费者组的初始化和分区的分配。 coordinator节点选择 = groupid的hashcode值 % 50（ consumer_offsets的分区数量） 例如： groupid的hashcode值 = 1，1% 50 = 1，那么__consumer_offsets 主题的1号分区，在哪个broker上，就选择这个节点的coordinator 作为这个消费者组的老大。消费者组下的所有的消费者提交offset的时候就往这个分区去提交offset。</p><h3 id="_5-2-3-消费者重要参数" tabindex="-1"><a class="header-anchor" href="#_5-2-3-消费者重要参数" aria-hidden="true">#</a> 5.2.3 消费者重要参数</h3><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>bootstrap.servers</td><td>向 Kafka 集群建立初始连接用到的 host/port 列表</td></tr><tr><td>key.deserializer 和 value.deserializer</td><td>指定接收消息的 key 和 value 的反序列化类型，一定要写全类名</td></tr><tr><td>group.id</td><td>标记消费者所属的消费者组</td></tr><tr><td>enable.auto.commit</td><td>默认值为 true，消费者会自动周期性地向服务器提交偏移量</td></tr><tr><td>auto.commit.interval.ms</td><td>如果设置了 enable.auto.commit 的值为 true， 则该值定义了消费者偏移量向 Kafka 提交的频率，默认 5s</td></tr><tr><td>auto.offset.reset</td><td>当 Kafka 中没有初始偏移量或当前偏移量在服务器中不存在（如，数据被删除了），该如何处理？ earliest：自动重置偏移量到最早的偏移量。 latest：默认，自动重置偏移量为最新的偏移量。 none：如果消费组原来的（previous）偏移量不存在，则向消费者抛异常。 anything：向消费者抛异常</td></tr><tr><td>offsets.topic.num.partitions</td><td>__consumer_offsets 的分区数，默认是 50 个分区</td></tr><tr><td>heartbeat.interval.ms</td><td>Kafka 消费者和 coordinator 之间的心跳时间，默认 3s。该条目的值必须小于 session.timeout.ms ，也不应该高于session.timeout.ms 的 1/3。</td></tr><tr><td>session.timeout.ms</td><td>Kafka 消费者和 coordinator 之间连接超时时间，默认 45s。超过该值，该消费者被移除，消费者组执行再平衡</td></tr><tr><td>max.poll.interval.ms</td><td>消费者处理消息的最大时长，默认是 5 分钟。超过该值，该消费者被移除，消费者组执行再平衡。</td></tr><tr><td>fetch.min.bytes</td><td>默认 1 个字节。消费者获取服务器端一批消息最小的字节数。</td></tr><tr><td>fetch.max.wait.ms</td><td>默认 500ms。如果没有从服务器端获取到一批数据的最小字节数。该时间到，仍然会返回数据。</td></tr><tr><td>fetch.max.bytes</td><td>默认 Default: 52428800（50 m）。消费者获取服务器端一批消息最大的字节数。如果服务器端一批次的数据大于该值（50m）仍然可以拉取回来这批数据，因此，这不是一个绝对最大值。一批次的大小受 message.max.bytes （broker config）or max.message.bytes （topic config）影响。</td></tr><tr><td>max.poll.records</td><td>一次 poll 拉取数据返回消息的最大条数，默认是 500 条。</td></tr></tbody></table></li></ol><h2 id="_5-3-消费者-api" tabindex="-1"><a class="header-anchor" href="#_5-3-消费者-api" aria-hidden="true">#</a> 5.3 消费者 API</h2><h3 id="_5-3-1-独立消费者案例-订阅主题" tabindex="-1"><a class="header-anchor" href="#_5-3-1-独立消费者案例-订阅主题" aria-hidden="true">#</a> 5.3.1 独立消费者案例（订阅主题）</h3><ol><li><p>需求：创建一个独立消费者，消费 first 主题中数据。 注意：<mark>在消费者 API 代码中必须配置消费者组 id</mark>，命令行启动消费者不填写消费者组id会被自动填写随机的消费者组 id。</p></li><li><p>代码实现</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>测试</p></li></ol><h3 id="_5-3-2-独立消费者案例-订阅分区" tabindex="-1"><a class="header-anchor" href="#_5-3-2-独立消费者案例-订阅分区" aria-hidden="true">#</a> 5.3.2 独立消费者案例（订阅分区）</h3><ol><li>需求：创建一个独立消费者，消费 first 主题 0 号分区的数据。</li><li>代码实现<div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li>测试</li></ol><h3 id="_5-3-3-消费者组案例" tabindex="-1"><a class="header-anchor" href="#_5-3-3-消费者组案例" aria-hidden="true">#</a> 5.3.3 消费者组案例</h3><ol><li><p>需求：测试同一个主题的分区数据，只能由一个消费者组中的一个消费。</p></li><li><p>代码实现</p><div class="language-java ext-java line-numbers-mode"><pre class="language-java"><code>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br></div></div></li><li><p>测试</p></li></ol><h2 id="_5-4-生产经验——分区的分配以及再平衡" tabindex="-1"><a class="header-anchor" href="#_5-4-生产经验——分区的分配以及再平衡" aria-hidden="true">#</a> 5.4 生产经验——分区的分配以及再平衡</h2><ol><li>一个consumer group中有多个consumer组成，一个 topic有多个partition组成，现在的问题是，到底由哪个consumer来消费哪个partition的数据。</li><li>Kafka有四种主流的分区分配策略： <strong>Range、RoundRobin、Sticky、CooperativeSticky</strong>。可以通过配置参数partition.assignment.strategy，修改分区的分配策略。默认策略是Range + CooperativeSticky。Kafka可以同时使用多个分区分配策略。</li></ol><table><thead><tr><th>参数名称</th><th>描述</th></tr></thead><tbody><tr><td>heartbeat.interval.ms</td><td>Kafka 消费者和 coordinator 之间的心跳时间，默认 3s。该条目的值必须小于 session.timeout.ms，也不应该高于session.timeout.ms 的 1/3。</td></tr><tr><td>session.timeout.ms</td><td>Kafka 消费者和 coordinator 之间连接超时时间，默认 45s。超过该值，该消费者被移除，消费者组执行再平衡。</td></tr><tr><td>max.poll.interval.ms</td><td>消费者处理消息的最大时长，默认是 5 分钟。超过该值，该消费者被移除，消费者组执行再平衡。</td></tr><tr><td>partition.assignment.strategy</td><td>消 费 者 分 区 分 配 策 略 ， 默 认 策 略 是 Range +CooperativeSticky。Kafka 可以同时使用多个分区分配策略。可 以 选 择 的 策 略 包 括 ： Range 、 RoundRobin 、 Sticky 、CooperativeSticky</td></tr></tbody></table><h3 id="_5-4-1-range以及再平衡" tabindex="-1"><a class="header-anchor" href="#_5-4-1-range以及再平衡" aria-hidden="true">#</a> 5.4.1 Range以及再平衡</h3><ol><li>Range分区策略原理</li><li>Range 分区分配策略案例</li><li>Range 分区分配再平衡案例</li></ol><h3 id="_5-4-2-roundrobin-以及再平衡" tabindex="-1"><a class="header-anchor" href="#_5-4-2-roundrobin-以及再平衡" aria-hidden="true">#</a> 5.4.2 RoundRobin 以及再平衡</h3><ol><li>RoundRobin 分区策略原理</li><li>RoundRobin 分区分配策略案例</li><li>RoundRobin 分区分配再平衡案例</li></ol><h3 id="_5-4-3-sticky-以及再平衡" tabindex="-1"><a class="header-anchor" href="#_5-4-3-sticky-以及再平衡" aria-hidden="true">#</a> 5.4.3 Sticky 以及再平衡</h3><ol><li>需求</li><li>步骤</li><li>Sticky 分区分配再平衡案例</li></ol><h2 id="_5-5-offset-位移" tabindex="-1"><a class="header-anchor" href="#_5-5-offset-位移" aria-hidden="true">#</a> 5.5 offset 位移</h2><h3 id="_5-5-1-offset-的默认维护位置" tabindex="-1"><a class="header-anchor" href="#_5-5-1-offset-的默认维护位置" aria-hidden="true">#</a> 5.5.1 offset 的默认维护位置</h3><ol><li>消费 offset 案例</li></ol><h3 id="_5-5-2-自动提交-offset" tabindex="-1"><a class="header-anchor" href="#_5-5-2-自动提交-offset" aria-hidden="true">#</a> 5.5.2 自动提交 offset</h3><ol><li>消费者自动提交 offset</li></ol><h3 id="_5-5-3-手动提交-offset" tabindex="-1"><a class="header-anchor" href="#_5-5-3-手动提交-offset" aria-hidden="true">#</a> 5.5.3 手动提交 offset</h3><ol><li>同步提交 offset</li><li>异步提交 offset</li></ol><h3 id="_5-5-4-指定-offset-消费" tabindex="-1"><a class="header-anchor" href="#_5-5-4-指定-offset-消费" aria-hidden="true">#</a> 5.5.4 指定 Offset 消费</h3><h3 id="_5-5-5-指定时间消费" tabindex="-1"><a class="header-anchor" href="#_5-5-5-指定时间消费" aria-hidden="true">#</a> 5.5.5 指定时间消费</h3><h3 id="_5-5-6-漏消费和重复消费" tabindex="-1"><a class="header-anchor" href="#_5-5-6-漏消费和重复消费" aria-hidden="true">#</a> 5.5.6 漏消费和重复消费</h3><h2 id="_5-6-生产经验——消费者事务" tabindex="-1"><a class="header-anchor" href="#_5-6-生产经验——消费者事务" aria-hidden="true">#</a> 5.6 生产经验——消费者事务</h2><h2 id="_5-7-生产经验——数据积压-消费者如何提高吞吐量" tabindex="-1"><a class="header-anchor" href="#_5-7-生产经验——数据积压-消费者如何提高吞吐量" aria-hidden="true">#</a> 5.7 生产经验——数据积压（消费者如何提高吞吐量）</h2><h1 id="第-6-章-kafka-eagle-监控" tabindex="-1"><a class="header-anchor" href="#第-6-章-kafka-eagle-监控" aria-hidden="true">#</a> 第 6 章 Kafka-Eagle 监控</h1><h2 id="_6-1-mysql-环境准备" tabindex="-1"><a class="header-anchor" href="#_6-1-mysql-环境准备" aria-hidden="true">#</a> 6.1 MySQL 环境准备</h2><h2 id="_6-2-kafka-环境准备" tabindex="-1"><a class="header-anchor" href="#_6-2-kafka-环境准备" aria-hidden="true">#</a> 6.2 Kafka 环境准备</h2><h2 id="_6-3-kafka-eagle-安装" tabindex="-1"><a class="header-anchor" href="#_6-3-kafka-eagle-安装" aria-hidden="true">#</a> 6.3 Kafka-Eagle 安装</h2><h2 id="_6-4-kafka-eagle-页面操作" tabindex="-1"><a class="header-anchor" href="#_6-4-kafka-eagle-页面操作" aria-hidden="true">#</a> 6.4 Kafka-Eagle 页面操作</h2><h1 id="第-7-章-kafka-kraft-模式" tabindex="-1"><a class="header-anchor" href="#第-7-章-kafka-kraft-模式" aria-hidden="true">#</a> 第 7 章 Kafka-Kraft 模式</h1><h2 id="_7-1-kafka-kraft-架构" tabindex="-1"><a class="header-anchor" href="#_7-1-kafka-kraft-架构" aria-hidden="true">#</a> 7.1 Kafka-Kraft 架构</h2><h2 id="_7-2-kafka-kraft-集群部署" tabindex="-1"><a class="header-anchor" href="#_7-2-kafka-kraft-集群部署" aria-hidden="true">#</a> 7.2 Kafka-Kraft 集群部署</h2><h2 id="_7-3-kafka-kraft-集群启动停止脚本" tabindex="-1"><a class="header-anchor" href="#_7-3-kafka-kraft-集群启动停止脚本" aria-hidden="true">#</a> 7.3 Kafka-Kraft 集群启动停止脚本</h2><!--]--></div><!----><footer class="page-meta"><div class="meta-item edit-link"><a href="https://github.com/vuepress-theme-hope/vuepress-theme-hope/edit/main/demo/src/middleware/mq/Kafka.md" rel="noopener noreferrer" target="_blank" arialabel="编辑此页" class="nav-link label"><!--[--><svg xmlns="http://www.w3.org/2000/svg" class="icon edit-icon" viewbox="0 0 1024 1024" arialabelledby="edit"><title id="edit" lang="en">edit icon</title><g fill="currentColor"><path d="M430.818 653.65a60.46 60.46 0 0 1-50.96-93.281l71.69-114.012 7.773-10.365L816.038 80.138A60.46 60.46 0 0 1 859.225 62a60.46 60.46 0 0 1 43.186 18.138l43.186 43.186a60.46 60.46 0 0 1 0 86.373L588.879 565.55l-8.637 8.637-117.466 68.234a60.46 60.46 0 0 1-31.958 11.229z"></path><path d="M728.802 962H252.891A190.883 190.883 0 0 1 62.008 771.98V296.934a190.883 190.883 0 0 1 190.883-192.61h267.754a60.46 60.46 0 0 1 0 120.92H252.891a69.962 69.962 0 0 0-69.098 69.099V771.98a69.962 69.962 0 0 0 69.098 69.098h475.911A69.962 69.962 0 0 0 797.9 771.98V503.363a60.46 60.46 0 1 1 120.922 0V771.98A190.883 190.883 0 0 1 728.802 962z"></path></g></svg><!--]-->编辑此页<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!----></a></div><div class="meta-item update-time"><span class="label">上次编辑于: </span><span class="info">2022/4/11 下午2:40:49</span></div><div class="meta-item contributors"><span class="label">贡献者: </span><!--[--><!--[--><span class="contributor" title="email: 1063415880@qq.com">cyl</span><!--]--><!--]--></div></footer><!----><div class="giscus-wrapper input-top" style="display:block;"><giscus-widget repo="vuepress-theme-hope/giscus-discussions" repoId="R_kgDOG_Pt2A" category="Announcements" categoryId="DIC_kwDOG_Pt2M4COD69" lang="zh-CN" theme="light" mapping="pathname" inputPosition="top" reactionsEnabled="1" emitMetadata="0"></giscus-widget></div><!----></main><!--]--><footer class="footer-wrapper"><div class="footer">默认页脚</div><div class="copyright">Copyright © 2022 Code Chen</div></footer></div><!--]--><!----><!--]--></div>
    <script type="module" src="/assets/app.62233a0d.js" defer></script>
  </body>
</html>
